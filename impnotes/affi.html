<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.4. Extensions-2.4. The Amiga Foreign Function Call Facility</title><link rel="stylesheet" href="impnotes.css" type="text/css" /><link rev="made" href="mailto:clisp-list@sf.net" /><meta name="generator" content="DocBook XSL Stylesheets V1.65.1" /><link rel="home" href="index.html" title="Implementation Notes for GNU CLISP." /><link rel="up" href="platform.html" title="Chapter 30. Extensions-2: Platform specific Extensions" /><link rel="previous" href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility" /><link rel="next" href="socket.html" title="30.5. Extensions-2.5. Socket Streams" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">30.4. Extensions-2.4. The Amiga Foreign Function Call Facility</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="dffi.html">Prev</a> </td><th width="60%" align="center">Chapter 30. Extensions-2: Platform specific Extensions</th><td width="20%" align="right"> <a accesskey="n" href="socket.html">Next</a></td></tr></table><hr /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="affi"></a>30.4. Extensions-2.4. The Amiga Foreign Function Call Facility</h2></div><div><h3 class="subtitle">Platform dependent: no platform supports this currently.</h3></div></div><div></div></div><div class="toc"><dl><dt><span class="section"><a href="affi.html#affi-design">30.4.1. Design issues</a></span></dt><dt><span class="section"><a href="affi.html#affi-overview">30.4.2. Overview</a></span></dt><dt><span class="section"><a href="affi.html#affi-libs">30.4.3. Foreign Libraries</a></span></dt><dt><span class="section"><a href="affi.html#affi-types">30.4.4. (Foreign) <span><b class="command">C</b></span> types</a></span></dt><dt><span class="section"><a href="affi.html#affi-functions">30.4.5. Foreign functions</a></span></dt><dt><span class="section"><a href="affi.html#affi-memory-access">30.4.6. Memory access</a></span></dt><dt><span class="section"><a href="affi.html#affi-func-def">30.4.7. Function Definition Files</a></span></dt><dt><span class="section"><a href="affi.html#affi-hints">30.4.8. Hints</a></span></dt><dt><span class="section"><a href="affi.html#affi-caveats">30.4.9. Caveats</a></span></dt><dt><span class="section"><a href="affi.html#affi-examples">30.4.10. Examples</a></span></dt></dl></div><p><b>Another Foreign Function Interface. </b>All symbols relating to the simple foreign function interface are
 exported from the package <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>. To use them,
 <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/fun_use-package.html" target="_top"><tt class="function">USE-PACKAGE</tt></a> "AFFI")</tt>.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-design"></a>30.4.1. Design issues</h3></div></div><div></div></div><p><a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> was designed to be small in size but powerful enough to
use most library functions.  Lisp files may be compiled to <tt class="filename">#P".fas"</tt>
files without the need to load function definition files at run-time and
without external <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> or linker support.
<a href="image.html" title="29.1. Extensions-1.1. Saving an Image">memory image</a>s can be created, provided that the function libraries are
opened at run-time.</p><p>Therefore, <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> supports only primitive <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types
(integers 8, 16 and 32 bits wide, signed or unsigned, pointers) and
defines no new types or classes.  Foreign functions are not first-class
objects (you can define a λ yourself), name spaces are
separate.</p><p>The <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> does no tracking of resources.  Use <a href="final.html" title="29.7. Extensions-1.7. Finalization"><tt class="function">EXT:FINALIZE</tt></a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-overview"></a>30.4.2. Overview</h3></div></div><div></div></div><p>These are the <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> forms:</p><p><tt class="sexp">(declare-library-base
 <i class="replaceable"><tt>keyword-base</tt></i> <i class="replaceable"><tt>library-name</tt></i>)</tt></p><p><tt class="sexp">(require-library-functions <i class="replaceable"><tt>library-name</tt></i>
 [(:import {<i class="replaceable"><tt>string-name</tt></i>}*)])</tt></p><p><tt class="sexp">(open-library
 <i class="replaceable"><tt>base-symbol</tt></i>)</tt></p><p><tt class="sexp">(close-library
 <i class="replaceable"><tt>base-symbol</tt></i>)</tt></p><p><tt class="sexp">(with-open-library
 (<i class="replaceable"><tt>base-symbol</tt></i> |
 <i class="replaceable"><tt>library-name</tt></i>) {<i class="replaceable"><tt>form</tt></i>}*)</tt></p><p><tt class="sexp">(defflibfun
 <i class="replaceable"><tt>function-name</tt></i>
 <i class="replaceable"><tt>base-symbol</tt></i>
 <i class="replaceable"><tt>offset</tt></i> <i class="replaceable"><tt>mask</tt></i>
 <i class="replaceable"><tt>result-type</tt></i>
 {<i class="replaceable"><tt>argument-type</tt></i>}*)</tt></p><p><tt class="sexp">(declare-library-function
 <i class="replaceable"><tt>function-name</tt></i>
 <i class="replaceable"><tt>library-name</tt></i> {<i class="replaceable"><tt>option</tt></i>}*)</tt></p><p><tt class="sexp">(flibcall <i class="replaceable"><tt>function-name</tt></i>
 {<i class="replaceable"><tt>argument</tt></i>}*)</tt></p><p><tt class="sexp">(mlibcall <i class="replaceable"><tt>function-name</tt></i>
 {<i class="replaceable"><tt>argument</tt></i>}*)</tt></p><p><tt class="sexp">(mem-read <i class="replaceable"><tt>address</tt></i>
  <i class="replaceable"><tt>result-type</tt></i> [<i class="replaceable"><tt>offset</tt></i>])</tt></p><p><tt class="sexp">(mem-write <i class="replaceable"><tt>address</tt></i>
 <i class="replaceable"><tt>type</tt></i> <i class="replaceable"><tt>value</tt></i> [<i class="replaceable"><tt>offset</tt></i>])</tt></p><p><tt class="sexp">(mem-write-vector <i class="replaceable"><tt>address</tt></i>
  <i class="replaceable"><tt>vector</tt></i> [<i class="replaceable"><tt>offset</tt></i>])</tt></p><p><tt class="sexp">(nzero-pointer-p <i class="replaceable"><tt>value</tt></i>)</tt></p><p>Except for <tt class="function">with-open-library</tt>,
<tt class="function">declare-library-function</tt> and
<tt class="function">mlibcall</tt>, all of the above are functions.</p><p>A library contains a collection of functions.  The library is
referred to by a symbol referred as library-base at the <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>
level.  This symbol is created in the package <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>.
The link between this symbol and the OS-level library name is
established by <tt class="function">declare-library-base</tt>.  To avoid
multiple package conflicts, this and only this function requires the
symbol-name to be in the <a href="http://www.lisp.org/HyperSpec/Body/sec_11-1-2-3.html" target="_top"><strong class="package">“<span class="quote">KEYWORD</span>”</strong></a> package. The function returns the
library-base.</p><p>A library may be opened by <tt class="function">open-library</tt> and
 closed by <tt class="function">close-library</tt>. An opened library must be
 closed. <tt class="function">with-open-library</tt> is provided to
 automatically close the library for you, thus it is much safer to
 use.</p><p>A function is contained in a library.  Every function is referred
to by a symbol.  A function is defined through
<tt class="function">defflibfun</tt> or
<tt class="function">declare-library-function</tt> by giving the function
name, the library-base, an offset into the library, a mask (or <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>)
for register-based library calls, the result type and all
parameter-types.  <tt class="function">require-library-functions</tt> loads
the complete set of functions defined in a library file. Symbols are
created in the package <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> and imported into the current
package.</p><p><tt class="function">flibcall</tt> and <tt class="function">mlibcall</tt>
call library functions. <tt class="function">mlibcall</tt> is a macro that
does a few checks at macroexpansion time and allows the compiler to
inline the call, not requiring the foreign function to be defined again
at load or execution time. The use of this macro is advertised wherever
possible.</p><p><tt class="function">mem-read</tt> reads an arbitrary address (with
offset for structure references) and returns the given type.</p><p><tt class="function">mem-write</tt> writes an arbitrary
address. <tt class="function">mem-write-vector</tt> copies the content of a
Lisp <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or <tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a> (<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8))</tt> into memory.</p><p><tt class="function">nzero-pointer-p</tt> tests for
non-<tt class="constant">NULL</tt> pointers in all recognized representations
(<a href="http://www.lisp.org/HyperSpec/Body/syscla_null.html" target="_top"><tt class="classname">NULL</tt></a>, <a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> and <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a>).</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-libs"></a>30.4.3. Foreign Libraries</h3></div></div><div></div></div><p><tt class="function">declare-library-base</tt> ought to be wrapped in an
<tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/speope_eval-when.html" target="_top"><tt class="function">EVAL-WHEN</tt></a> (compile eval load) ...)</tt>
form and come before any function is referenced, because the library
base symbol must be known.</p><p><tt class="function">open-library</tt> tries to open the library
referenced by the base symbol.  Therefore it must have been preceded
with <tt class="function">declare-library-base</tt>.  The call returns <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>
on failure. <tt class="function">open-library</tt> calls nest.  Every
successful call must be matched by <tt class="function">close-library</tt>.
<tt class="function">with-open-library</tt> does this for you and also allows
you to specify the library by name, provided that its base has been
declared.  It is recommended to use this macro and to reference the
library by name.</p><p><a href="http://clisp.cons.org" target="_top"><span><b class="command">CLISP</b></span></a> will not close libraries for you at program exit.  [A
previous version did so but now <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> is a module and there are no
module exit functions.]  Programmers, watch
<tt class="function">AFFI::*LIBRARIES-ALIST*</tt>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-types"></a>30.4.4. (Foreign) <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types</h3></div></div><div></div></div><p>The following foreign <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types are used in <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>.
They are <span class="emphasis"><em>not</em></span> regular <a href="http://www.lisp.org" target="_top"><span><b class="command">Common Lisp</b></span></a> types or <span><b class="command">CLOS</b></span> classes.
</p><div class="informaltable"><a id="affi-types-tab"></a><table border="1"><colgroup><col /><col /><col /><col /><col /></colgroup><thead><tr><th align="center"><a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> name</th><th align="center">Lisp equivalent</th><th align="center"><a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> equivalent</th><th align="center">Comment</th><td class="auto-generated"> </td></tr></thead><tbody><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a></td><td align="center"><span class="type">void</span></td><td align="center">as a result type for functions only</td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">4</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 32)</tt></td><td align="center"><span class="type">unsigned long</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">2</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 16)</tt></td><td align="center"><span class="type">unsigned short</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">1</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8)</tt></td><td align="center"><span class="type">unsigned char</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">-4</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 32)</tt></td><td align="center"><span class="type">long</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">-2</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 16)</tt></td><td align="center"><span class="type">short</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">-1</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 8)</tt></td><td align="center"><span class="type">signed char</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">0</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_boolean.html" target="_top"><tt class="classname">BOOLEAN</tt></a></td><td align="center"><span class="type">BOOL</span></td><td align="center">as a result type for functions only</td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">*</span></td><td align="center">opaque</td><td align="center"><span class="type">void*</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><tt class="constant">:EXTERNAL</tt></td><td align="center">opaque</td><td align="center"><span class="type">void*</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or <a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a></td><td align="center"><span class="type">char*</span></td><td align="center"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><tt class="constant">:IO</tt></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or <a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a></td><td align="center"><span class="type">char*</span></td><td align="center"> </td><td class="auto-generated"> </td></tr></tbody></table></div><p>Objects of type <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> are copied and passed
<tt class="constant">NULL</tt>-terminated on the execution stack.  On return, a Lisp string is
allocated and filled from the address returned (unless <tt class="constant">NULL</tt>).
Functions with <tt class="constant">:IO</tt> parameters are passed the address of the Lisp
string or unsigned byte vector. These are not <tt class="constant">NULL</tt>-terminated!
This is useful for functions like like <a href="http://www.opengroup.org/onlinepubs/007904975/functions/read.html" target="_top"><tt class="function">read</tt></a> which
do not need an array at a constant address longer than the dynamic
extent of the call (it is dangerous to define callback functions with
<tt class="constant">:IO</tt> (or <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a>) type parameters).
Arguments of type <a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a> and <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a> are always
acceptable where a <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or <tt class="constant">:IO</tt> type is specified.</p>
<!--#ifdef UNICODE--><p>See also <a href="encoding.html#foreign-enc"><tt class="varname">CUSTOM:*FOREIGN-ENCODING*</tt></a>.</p>
<!--#endif-->
<p>To meet the design goals, predefined types and objects were
used. As such, pointers were represented as integers. Now that there is
the <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a> type, both representations may be used on input.
The pointer type should be therefore considered as opaque.
Use <tt class="function">nzero-pointer-p</tt> for <tt class="constant">NULL</tt> tests.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-functions"></a>30.4.5. Foreign functions</h3></div></div><div></div></div><p>Foreign Functions are declared either through
<tt class="function">defflibfun</tt> or
<tt class="function">declare-library-function</tt>.  The former is closer to
the low-level implementation of the interface, the latter is closer to
the other <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a>.</p><p><tt class="function">defflibfun</tt> requires the library base symbol
and register mask to be specified,
<tt class="function">declare-library-function</tt> requires the library name
and computes the mask from the declaration of the arguments.</p><p>The value of mask is implementation-dependent.</p><p>The <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> type <tt class="literal">0</tt> is only acceptable as a
function result type and yields either <a href="http://www.lisp.org/HyperSpec/Body/convar_t.html" target="_top"><tt class="constant">T</tt></a> or <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>. The difference
between <tt class="function">*</tt> and <tt class="constant">:EXTERNAL</tt> is the following:
<tt class="function">*</tt> uses integers, <tt class="constant">:EXTERNAL</tt> uses
<a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a> as function result-type (except from <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> for a
<tt class="constant">NULL</tt> pointer) and refuses objects of type <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or
<tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a> (<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8))</tt> as input.  Thus <tt class="constant">:EXTERNAL</tt> provides some security
on the input and the ability to use <a href="final.html" title="29.7. Extensions-1.7. Finalization"><tt class="function">EXT:FINALIZE</tt></a> for resource-tracking on
the output side.</p><p><tt class="sexp">(declare-library-function <i class="replaceable"><tt>name</tt></i>
 <i class="replaceable"><tt>library-name</tt></i> {<i class="replaceable"><tt>option</tt></i>}*)</tt>

</p><div class="variablelist"><dl><dt><i class="replaceable"><tt>option</tt></i> ::==</dt><dd><div class="informaltable"><a id="affi-dec-lib-fun-opt-bnf"></a><table border="1"><colgroup><col /><col /></colgroup><tbody><tr><td align="left"> </td><td align="left"><tt class="sexp">(:offset
    <i class="replaceable"><tt>library-offset</tt></i>)</tt></td></tr><tr><td align="left">|</td><td align="left"><tt class="sexp">(<tt class="constant">:ARGUMENTS</tt>
    {(<i class="replaceable"><tt>argument</tt></i> <i class="replaceable"><tt><a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>-type</tt></i>
      <i class="replaceable"><tt>register</tt></i>)}*)</tt></td></tr><tr><td align="left">|</td><td align="left"><tt class="sexp">(:return-type
    <i class="replaceable"><tt><a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>-type</tt></i>)</tt></td></tr></tbody></table></div></dd><dt><i class="replaceable"><tt>register</tt></i> ::==</dt><dd><tt class="constant">:d0</tt> | <tt class="constant">:d1</tt>
 | ... | <tt class="constant">:d7</tt> | <tt class="constant">:a0</tt> | ... |
 <tt class="constant">:a6</tt></dd></dl></div><p>

declares a named library function for further reference through
<tt class="function">flibcall</tt> and <tt class="function">mlibcall</tt>.</p><p><tt class="function">mlibcall</tt> should be the preferred way of
calling foreign functions (when they are known at compile-time) as
macroexpansion-time checks may be performed and the call can be sort of
inlined.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-memory-access"></a>30.4.6. Memory access</h3></div></div><div></div></div><p><tt class="sexp">(affi:mem-read <i class="replaceable"><tt>address</tt></i> <i class="replaceable"><tt>type</tt></i>
  <i class="replaceable"><tt>offset</tt></i>)</tt> can read 8, 16 and 32 bit
signed or unsigned integers (<a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> types <span class="type">-4</span>,
<span class="type">-2</span>, <span class="type">-1</span>, <span class="type">1</span>, <span class="type">2</span>,
<span class="type">4</span>), a pointer (<span class="type">*</span>), a <tt class="constant">NULL</tt>-terminated
string (<span class="type">string</span>) or, if the type argument is of type
<a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or <tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a> (<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8))</tt>, it can fill this vector.
<tt class="constant">:EXTERNAL</tt> is not an acceptable type as no object can be created by
using <tt class="function">affi:mem-read</tt>.</p><p><tt class="sexp">(affi:mem-write <i class="replaceable"><tt>address</tt></i> <i class="replaceable"><tt>type</tt></i> <i class="replaceable"><tt>value</tt></i>
[<i class="replaceable"><tt>offset</tt></i>])</tt> writes integers (<a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a>
type <span class="type">-4</span>, <span class="type">-2</span>, <span class="type">-1</span>, <span class="type">1</span>,
<span class="type">2</span> and <span class="type">4</span>) or pointer values (type
<span class="type">*</span>), but not vectors to the specified memory address.</p><p><tt class="sexp">(affi:mem-write-vector <i class="replaceable"><tt>address</tt></i>
  <i class="replaceable"><tt>vector</tt></i> [<i class="replaceable"><tt>offset</tt></i>])</tt> can write
memory from the given vector (of type <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a> or <tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a> (<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8))</tt>).
</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-func-def"></a>30.4.7. Function Definition Files</h3></div></div><div></div></div><p><tt class="function">affi:require-library-functions</tt> will <a href="http://www.lisp.org/HyperSpec/Body/fun_providecm_require.html" target="_top"><tt class="function">REQUIRE</tt></a> a
file of name derived from thelibrary name and with type
<tt class="filename">affi</tt>. It may be used to import all names into the
current package or only a given subset identified by string names, using
the <tt class="constant">:import</tt> keyword (recommended use).
Some definition files for standard Amiga libraries are provided.
See <a href="affi.html#affi-ex-1-predefined" title="Example 30.13. Using a predefined library function file">Example 30.13, “Using a predefined library function file”</a> below.</p><p>As <tt class="function">affi:require-library-functions</tt> loads a
global file which you, the programmer, may have not defined, you may
consider declaring every function yourself to be certain what the return
and argument types are.
See <a href="affi.html#affi-ex-4-sample" title="Example 30.16. Some sample function definitions">Example 30.16, “Some sample function definitions”</a> below.</p><p>The file <tt class="filename">read-fd.lisp</tt> defines the function
<tt class="function">make-partial-fd-file</tt> with which the provided
<tt class="filename">.affi</tt> files have been prepared from the original
Amiga FD files (located in the directory <tt class="filename">FD:</tt>).
They must still be edited as the function cannot know whether a function
accepts a <tt class="function">*</tt>, <tt class="constant">:IO</tt>,
<tt class="function">string</tt> or <tt class="constant">:EXTERNAL</tt> argument and because files
in <tt class="filename">FD:</tt> only contain a register specification, not
the width of integer arguments (<tt class="literal">-4</tt>,
<tt class="literal">-2</tt>, <tt class="literal">-1</tt>, <tt class="literal">1</tt>,
<tt class="literal">2</tt>, or <tt class="literal">4</tt>).</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-hints"></a>30.4.8. Hints</h3></div></div><div></div></div><p>By using appropriate <a href="http://www.lisp.org/HyperSpec/Body/speope_eval-when.html" target="_top"><tt class="function">EVAL-WHEN</tt></a> forms for
<tt class="function">affi:declare-library-base</tt> and
<tt class="function">affi:require-library-functions</tt> and not using
<tt class="function">affi:flibcall</tt>, it is possible to write code that
only loads library function definition files at compile-time.
See <a href="affi.html#affi-ex-1-predefined" title="Example 30.13. Using a predefined library function file">Example 30.13, “Using a predefined library function file”</a> below.</p><p>Do not rely on <a href="final.html" title="29.7. Extensions-1.7. Finalization"><tt class="function">EXT:FINALIZE</tt></a> to free resources for you, as <a href="http://clisp.cons.org" target="_top"><span><b class="command">CLISP</b></span></a>
does not call finalizers when it exits, use <a href="http://www.lisp.org/HyperSpec/Body/speope_unwind-protect.html" target="_top"><tt class="function">UNWIND-PROTECT</tt></a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-caveats"></a>30.4.9. Caveats</h3></div></div><div></div></div><p>You can consider the library bases being symbols in need of being
imported from the package <a href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility"><strong class="package">“<span class="quote">AFFI</span>”</strong></a> originating from a brain-damage, causing
the usual symbol headaches when using foreign functions calls within
macros.  Luckily, even if the high-level interface (or its
implementation in <tt class="filename">affi1.lisp</tt>) were to change, the
low-level part (<tt class="filename">affi.d</tt>) should remain untouched as
all it knows are <a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a>s and <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a>s, no <a href="http://www.lisp.org/HyperSpec/Body/syscla_symbol.html" target="_top"><tt class="classname">SYMBOL</tt></a>s.
The difficulty is just to get the library base value at run-time.
Feel free to suggest enhancements to this facility!</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="affi-examples"></a>30.4.10. Examples</h3></div><div><h4 class="subtitle">NB: These examples are somewhat specific to the Amiga.</h4></div></div><div></div></div><div class="example"><a id="affi-ex-1-predefined"></a><p class="title"><b>Example 30.13. Using a predefined library function file</b></p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="http://www.lisp.org/HyperSpec/Body/mac_defpackage.html" target="_top"><tt class="function">DEFPACKAGE</tt></a> "AFFI-TEST" (:use "LISP" "AFFI"))
(<a href="http://www.lisp.org/HyperSpec/Body/mac_in-package.html" target="_top"><tt class="function">IN-PACKAGE</tt></a> "AFFI-TEST")

;; SysBase is the conventional name for exec.library
;; It is only enforced by the file loaded by REQUIRE-LIBRARY-FUNCTIONS
(eval-when (compile eval load)
  (declare-library-base :SysBase "exec.library")) ;keyword avoids name conflicts

;; using only MLIBCALL allows not to load definitions at load-time
(eval-when (compile eval)
  (require-library-functions "exec.library"
    :import '("FindTask")))

(with-open-library ("exec.library")
  (print (mlibcall FindTask 0)))
</pre></td></tr></table><p>

This file can be used in interpreted and compiled mode.
Compiled, it will have inlined the library function calls.
</p></div><div class="example"><a id="affi-ex-2-flibcall"></a><p class="title"><b>Example 30.14. Using flibcall</b></p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="http://www.lisp.org/HyperSpec/Body/mac_defpackage.html" target="_top"><tt class="function">DEFPACKAGE</tt></a> "AFFI-TEST" (:use "LISP" "AFFI"))
(<a href="http://www.lisp.org/HyperSpec/Body/mac_in-package.html" target="_top"><tt class="function">IN-PACKAGE</tt></a> "AFFI-TEST")

(eval-when (compile eval load)
  ;; keyword avoids name conflicts
  (declare-library-base :SysBase "exec.library"))

;; The load situation permits the use of flibcall
(eval-when (eval compile load)
  (require-library-functions "exec.library"))

(unless (open-library 'SysBase) (error "No library for SysBase"))
(flibcall (if t 'FindTask 'Debug) 0)
(close-library 'SysBase)
</pre></td></tr></table></div><div class="example"><a id="affi-ex-3-dynamic"></a><p class="title"><b>Example 30.15. Be fully dynamic, defining library bases ourselves</b></p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="http://www.lisp.org/HyperSpec/Body/mac_defpackage.html" target="_top"><tt class="function">DEFPACKAGE</tt></a> "AFFI-TEST" (:use "LISP" "AFFI"))
(<a href="http://www.lisp.org/HyperSpec/Body/mac_in-package.html" target="_top"><tt class="function">IN-PACKAGE</tt></a> "AFFI-TEST")

(eval-when (compile eval load)
  (defvar mylib (declare-library-base :foobase "foo.library")))
(eval-when (eval compile load)          ;eval allows mlibcall, load flibcall
  (defflibfun 'foo1 mylib -30 '#xA '* 'string)
  (defflibfun 'foo2 mylib -36 '#x21 0 * 4))

(defun foo (name)
  (when (open-library mylib)
    (list (mlibcall foo1 name) (flibcall 'foo2 name 123213))
    (close-library mylib)))
</pre></td></tr></table></div><div class="example"><a id="affi-ex-4-sample"></a><p class="title"><b>Example 30.16. Some sample function definitions</b></p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(defflibfun 'FindTask 'SysBase -294 #xA '* 'string)
(eval-library-function FindTask "exec.library"
  (:offset -294)
  (:return-type *)
  (:arguments
   (name   string   :A1)))
(declare-library-function NameFromLock "dos.library"
  (:offset -402)
  (:return-type 0)
  (:arguments
   (lock   4   :D1)
   (buffer :io :D2)
   (len    4   :D3)))

(eval-when (compile eval)
  (defconstant GVF_LOCAL_ONLY (ash 1 9))
  (defflibfun 'SetVar 'DosBase -900 #x5432 0 'string 'string -4 4))
(defun setvar (name value)
  (with-open-library (DosBase)
    ;; length of -1 means find length of <tt class="constant">NULL</tt>-terminated-string
    (mlibcall SetVar name value -1 GVF_LOCAL_ONLY)))
</pre></td></tr></table></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="dffi.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="platform.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="socket.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">30.3. Extensions-2.3. The Foreign Function Call Facility </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 30.5. Extensions-2.5. Socket Streams</td></tr></table></div><div class="custom-footer"><hr width="100%" /><table width="100%"><tr><td align="left"><a href="http://clisp.cons.org"><img src="clisp.png" width="48" height="48" alt="[CLISP home]" /></a></td><td align="center"><a href="http://www.gnu.org"><img src="http://www.gnu.org/graphics/gnubanner.jpg" width="468" height="60" alt="[Come and see what GNU creates for YOU]" /></a></td><td align="right"><a href="http://sourceforge.net"><img src="http://sourceforge.net/sflogo.php?group_id=1355&amp;amp;type=2" width="125" height="37" alt="[SourceForge]" /></a></td></tr></table></div></body></html>
