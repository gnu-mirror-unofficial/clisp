<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:cf="http://docbook.sourceforge.net/xmlns/chunkfast/1.0"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>31.2. External Modules</title><link rel="stylesheet" href="impnotes.css" type="text/css" /><link rev="made" href="mailto:clisp-list@sf.net" /><meta name="generator" content="DocBook XSL Stylesheets V2005-07-12_04:47_snapshot" /><link rel="start" href="index.html" title="Implementation Notes for GNU CLISP." /><link rel="up" href="ext-platform.html" title="Chapter 31. Platform Specific Extensions" /><link rel="prev" href="screen.html" title="31.1. Random Screen Access" /><link rel="next" href="dffi.html" title="31.3. The Foreign Function Call Facility" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">31.2. External Modules</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="screen.html">Prev</a> </td><th width="60%" align="center">Chapter 31. Platform Specific Extensions</th><td width="20%" align="right"> <a accesskey="n" href="dffi.html">Next</a></td></tr></table><hr /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="modules"></a>31.2. External Modules</h2></div><div><h3 class="subtitle"><span class="plat-dep">Platform Dependent: <span class="plat-dep"><a href="http://www.UNIX-systems.org/online.html" target="_top"><span class="strong"><strong>UNIX</strong></span></a>, <a href="http://winehq.com/" target="_top"><span class="strong"><strong>Win32</strong></span></a> platforms only.</span></span></h3></div></div></div><div class="toc"><dl><dt><span class="section"><a href="modules.html#mod-overview">31.2.1. Overview</a></span></dt><dt><span class="section"><a href="modules.html#modinit">31.2.2. Module initialization.</a></span></dt><dt><span class="section"><a href="modules.html#modfini">31.2.3. Module finalization.</a></span></dt><dt><span class="section"><a href="modules.html#modinfo">31.2.4. Function <code class="function">EXT:MODULE-INFO</code></a></span></dt><dt><span class="section"><a href="modules.html#mod-dynload">31.2.5. Function <code class="function">SYS::DYNLOAD-MODULES</code></a></span></dt><dt><span class="section"><a href="modules.html#mod-set-example">31.2.6. Example</a></span></dt><dt><span class="section"><a href="modules.html#module-tools">31.2.7. Module tools</a></span></dt><dd><dl><dt><span class="section"><a href="modules.html#modprep">31.2.7.1. Modprep</a></span></dt><dt><span class="section"><a href="modules.html#clisp-h">31.2.7.2. clisp.h</a></span></dt><dt><span class="section"><a href="modules.html#exporting">31.2.7.3. Exporting</a></span></dt></dl></dd><dt><span class="section"><a href="modules.html#included-modules">31.2.8. Modules included in the source distribution.</a></span></dt><dd><dl><dt><span class="section"><a href="modules.html#base-modules">31.2.8.1. Base and Full Modules</a></span></dt></dl></dd></dl></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="mod-win32"></a>Modules on <span class="strong"><strong>Win32</strong></span>.</h3><p>Everything described in the section will work verbatim on <a href="http://winehq.com/" target="_top"><span class="strong"><strong>Win32</strong></span></a>
  when using <a href="http://cygwin.com/" target="_top"><span class="strong"><strong>Cygwin</strong></span></a> or <a href="http://www.mingw.org/" target="_top"><span class="strong"><strong>MinGW</strong></span></a>, <span class="emphasis"><em>except</em></span> for one
  thing - you will need to replace the <code class="filename">run</code>
  extension in <code class="filename">lisp.run</code> with the <a href="http://winehq.com/" target="_top"><span class="strong"><strong>Win32</strong></span></a> executable
  extension <code class="filename">exe</code>.</p><p>For historical reasons, all examples appear to assume <a href="http://www.UNIX-systems.org/online.html" target="_top"><span class="strong"><strong>UNIX</strong></span></a> and
  use the <code class="filename">run</code> file type (“<span class="quote">extension</span>”)
  for the <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> run-time.
  This does <span class="strong"><strong>not</strong></span> mean that they will not work on <a href="http://winehq.com/" target="_top"><span class="strong"><strong>Win32</strong></span></a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="mod-overview"></a>31.2.1. Overview</h3></div></div></div><p><a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> has a facility for adding external modules (written in
 <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a>, for example).  It is invoked through
 <span><strong class="command">clisp-link</strong></span>.</p><p>A <strong class="first"><em class="firstterm">module<a id="module" class="indexterm"></a></em></strong> is a
 piece of external code which defines extra Lisp objects, symbols and
 functions.  A module <strong class="first"><em class="firstterm">name</em></strong> must consist of the
 characters <code class="filename">A</code>-<code class="filename">Z</code>,
 <code class="filename">a</code>-<code class="filename">z</code>, <code class="filename">_</code>,
 <code class="filename">0</code>-<code class="filename">9</code>.
 The module name “<span class="quote">clisp</span>” is reserved.
 Normally a module name is derived from the corresponding file name.</p><p><span><strong class="command">clisp-link</strong></span> needs a directory containing:
</p><div class="itemizedlist"><ul type="disc"><li><code class="filename">"modules.d"</code></li><li><code class="filename">"modules.c"</code></li><li><a href="modules.html#clisp-h" title="31.2.7.2. clisp.h"><code class="filename">"clisp.h"</code></a></li></ul></div><p>
<span><strong class="command">clisp-link</strong></span> expects to find these files in a
subdirectory <code class="filename">linkkit/</code> of the current directory.
This can be overridden by the <a href="http://www.opengroup.org/onlinepubs/007904975/basedefs/xbd_chap08.html" target="_top">environment variable</a> <code class="envar">CLISP_LINKKIT</code>.</p><p><span><strong class="command">clisp-link</strong></span> operates on <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> <a href="modules.html#linkset" class="olink">linking set</a>s and
 on <a href="modules.html#modset" class="olink">module set</a>s.</p><p><a id="linkset"></a><b><a href="modules.html#linkset" class="olink">linking set</a>. </b>A <strong class="first"><em class="firstterm"><a href="modules.html#linkset" class="olink">linking set</a><a id="linkseti" class="indexterm"></a></em></strong>
   is a directory containing:
</p><div class="variablelist"><dl><dt><code class="filename">makevars</code></dt><dd><p>some <a href="http://www.opengroup.org/onlinepubs/007904975/utilities/sh.html" target="_top"><span><strong class="command">/bin/sh</strong></span></a> commands, setting the variables
</p><div class="variablelist"><dl><dt><code class="envar">CC</code></dt><dd>the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> compiler
 </dd><dt><code class="envar">CPPFLAGS</code></dt><dd>flags for the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> compiler, when preprocessing
    or compiling</dd><dt><code class="envar">CFLAGS</code></dt><dd>flags for the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> compiler, when compiling or
    linking</dd><dt><code class="envar">CLFLAGS</code></dt><dd>flags for the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> compiler, when linking
 </dd><dt><code class="envar">LIBS</code></dt><dd>libraries to use when linking
 </dd><dt><code class="envar">X_LIBS</code></dt><dd>additional <a href="http://www.x.org/" target="_top">X Window System</a> libraries to use
 </dd><dt><code class="envar">RANLIB</code></dt><dd>the ranlib command
 </dd><dt><code class="envar">FILES</code></dt><dd>the list of files needed when linking
 </dd></dl></div></dd><dt><code class="filename">modules.h</code></dt><dd>the list of modules contained in this <a href="modules.html#linkset" class="olink">linking set</a>
</dd><dt><code class="filename">modules.o</code></dt><dd>the compiled list of modules contained in this <a href="modules.html#linkset" class="olink">linking set</a>
</dd><dt>all the <code class="filename">FILES</code></dt><dd>listed in <code class="filename">makevars</code>
</dd><dt><code class="filename">lisp.run</code></dt><dd>the executable</dd><dt><a href="image.html" title="30.2. Saving an Image"><code class="filename">lispinit.mem</code></a></dt><dd>the <a href="image.html" class="olink">memory image</a></dd></dl></div><p>To run a <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> contained in some <a href="modules.html#linkset" class="olink">linking set</a> <em class="replaceable"><code>directory</code></em>, call
 <span><strong class="command"><em class="replaceable"><code>directory</code></em>/lisp.run -M <em class="replaceable"><code>directory</code></em>/lispinit.mem</strong></span>
 or <span><strong class="command">clisp <code class="option"><a href="clisp.html#opt-link-set" class="olink">-K</a></code> <em class="replaceable"><code>directory</code></em></strong></span>.</p><p><a id="modset"></a><b><a href="modules.html#modset" class="olink">module set</a>. </b>A <strong class="first"><em class="firstterm"><a href="modules.html#modset" class="olink">module set</a><a id="modseti" class="indexterm"></a></em></strong>
   is a directory containing:
</p><div class="variablelist"><dl><dt><a href="modules.html#modset" class="olink"><span><strong class="command">link.sh</strong></span></a></dt><dd>some <a href="http://www.opengroup.org/onlinepubs/007904975/utilities/sh.html" target="_top"><span><strong class="command">/bin/sh</strong></span></a> commands, which prepare the directory
  before linking, and set the variables <code class="envar">NEW_FILES</code>,
  <code class="envar">NEW_LIBS</code>, <code class="envar">NEW_MODULES</code>, <a href="modules.html#mod-load"><code class="envar">TO_LOAD</code></a>
  and optionally <a href="modules.html#mod-preload"><code class="envar">TO_PRELOAD</code></a></dd><dt>and any other files</dt><dd>needed by <a href="modules.html#modset" class="olink"><span><strong class="command">link.sh</strong></span></a>
 </dd></dl></div><p>In <a href="modules.html#modset" class="olink"><span><strong class="command">link.sh</strong></span></a> the <a href="modules.html#modset" class="olink">module set</a> directory
 is referred to as <code class="varname">$modulename/</code>.</p><div class="variablelist"><dl><dt><code class="envar">NEW_FILES</code></dt><dd>the space-separated list of files that
  belong to the <a href="modules.html#modset" class="olink">module set</a> and will belong to every new <a href="modules.html#linkset" class="olink">linking set</a>.
 </dd><dt><code class="envar">NEW_LIBS</code></dt><dd>the space-separated list of files or
  <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> compiler switches that need to be passed to the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a>
  compiler when linking the <code class="filename">lisp.run</code> belonging to a new <a href="modules.html#linkset" class="olink">linking set</a>.
 </dd><dt><code class="envar">NEW_MODULES</code></dt><dd>the space-separated list of the module names
  belonging to the <a href="modules.html#modset" class="olink">module set</a>.  Normally, every <code class="filename">#P".c"</code> file in the
  <a href="modules.html#modset" class="olink">module set</a> defines a module of its own.  The module name is derived
  from the file name.</dd><dt><a id="mod-load"></a><a href="modules.html#mod-load"><code class="envar">TO_LOAD</code></a></dt><dd>the space-separated list of Lisp files to load
  before building the <a href="image.html" title="30.2. Saving an Image"><code class="filename">lispinit.mem</code></a> belonging to a new <a href="modules.html#linkset" class="olink">linking set</a>.
 </dd><dt><a id="mod-preload"></a><a href="modules.html#mod-preload"><code class="envar">TO_PRELOAD</code></a> (optional)</dt><dd><p>the space-separated list of Lisp files to load
  into an intermediate <a href="image.html" title="30.2. Saving an Image"><code class="filename">lispinit.mem</code></a> file, before building the <a href="image.html" title="30.2. Saving an Image"><code class="filename">lispinit.mem</code></a>
  belonging to a new <a href="modules.html#linkset" class="olink">linking set</a>.
  This variable is usually used to <a href="pack-dict.html#make-pack" title="11.5.1. Function MAKE-PACKAGE">create</a>
  (or <a href="pack-lock.html" title="11.1. Constraints on the “COMMON-LISP” Package&#10;  for Conforming Programs - package locking&#10; [CLHS-11.1.2.1.2]">unlock</a>) the Lisp <a href="http://www.lisp.org/HyperSpec/Body/syscla_package.html" target="_top"><code class="classname">PACKAGE</code></a>s which
  must be present when the new <code class="filename">#P".c"</code> files are initialized.
  E.g., the <a href="dffi.html#def-call-in"><code class="function">FFI:DEF-CALL-IN</code></a> functions must reside in already defined packages;
  see <a href="dffi.html#ex-call-in" title="Example 31.5. Calling Lisp from C">Example 31.5, “Calling Lisp from <span><strong class="command">C</strong></span>”</a>.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>If you are unlocking a package, you must also
    <a href="http://www.lisp.org/HyperSpec/Body/fun_removecm__elete-if-not.html" target="_top"><code class="function">DELETE</code></a> it from <a href="pack-lock.html" title="11.1. Constraints on the “COMMON-LISP” Package&#10;  for Conforming Programs - package locking&#10; [CLHS-11.1.2.1.2]"><code class="varname">CUSTOM:*SYSTEM-PACKAGE-LIST*</code></a> (see <a href="image.html" title="30.2. Saving an Image">Section 30.2, “Saving an Image”</a>)
    here and re-add it to <a href="pack-lock.html" title="11.1. Constraints on the “COMMON-LISP” Package&#10;  for Conforming Programs - package locking&#10; [CLHS-11.1.2.1.2]"><code class="varname">CUSTOM:*SYSTEM-PACKAGE-LIST*</code></a> in one of the <a href="modules.html#mod-load"><code class="envar">TO_LOAD</code></a>
    files.</p></div></dd></dl></div><p>The command <span><strong class="command">clisp-link create-module-set <em class="replaceable"><code>module</code></em>
 <em class="replaceable"><code>file1.c</code></em> ...</strong></span> creates a <a href="modules.html#modset" class="olink">module set</a>
 in <em class="replaceable"><code>module</code></em> directory which refers (via symbolic links)
 to <em class="replaceable"><code>file1.c</code></em> etc.
 The files are expected to be modules of their own.</p><p>The command <span><strong class="command">clisp-link add-module-set <em class="replaceable"><code>module</code></em> <em class="replaceable"><code>source</code></em>
 <em class="replaceable"><code>destination</code></em></strong></span> combines a <a href="modules.html#linkset" class="olink">linking set</a> in directory <em class="replaceable"><code>source</code></em> and a
 <a href="modules.html" title="31.2. External Modules">module</a> in directory <em class="replaceable"><code>module</code></em> to a new <a href="modules.html#linkset" class="olink">linking set</a>, in the directory
 <em class="replaceable"><code>destination</code></em> which is newly created.</p><p>The command <span><strong class="command">clisp-link run <em class="replaceable"><code>source</code></em> <em class="replaceable"><code>module</code></em> ...</strong></span>
 runs the <a href="modules.html#linkset" class="olink">linking set</a> in directory <em class="replaceable"><code>source</code></em>, with the <a href="modules.html" title="31.2. External Modules">module</a> in
 directory <em class="replaceable"><code>module</code></em> loaded.
 More than one module can be specified.
 If <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> has been built with the configuration option
 <code class="option">--with-dynamic-modules</code>, the loading will be performed
 through <a href="modules.html#mod-dynload" title="31.2.5. Function SYS::DYNLOAD-MODULES">dynamic loading</a>.
 Otherwise - this is much slower - a temporary <a href="modules.html#linkset" class="olink">linking set</a> will be created
 and deleted afterwards.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="modinit"></a>31.2.2. Module initialization.</h3></div></div></div><p>Each module has two initialization functions:
</p><div class="variablelist"><dl><dt><code class="function">module__<em class="replaceable"><code>name</code></em>__init_function_1</code></dt><dd><p>called only <span class="emphasis"><em>once</em></span> when <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>
  discovers while loading a <a href="image.html" class="olink">memory image</a> that there is a module present
  in the executable (<code class="filename">lisp.run</code>) which was not present at the time the
  image was saved.  It can be used to create Lisp objects,
  e.g. functions or keywords, and is indeed used for that purpose by
  <a href="modules.html#modprep" title="31.2.7.1. Modprep"><span><strong class="command">modprep.lisp</strong></span></a>.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>The <a href="http://www.lisp.org/HyperSpec/Body/syscla_package.html" target="_top"><code class="classname">PACKAGE</code></a>s must already exist and be unlocked,
   cf. <a href="modules.html#mod-preload"><code class="envar">TO_PRELOAD</code></a>.</p></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>If you are using <a href="modules.html#modprep" title="31.2.7.1. Modprep"><span><strong class="command">modprep.lisp</strong></span></a> <span class="strong"><strong>and</strong></span>
   defining your own “<span class="quote">init-once</span>” function, it must call the
   <code class="function">module__<em class="replaceable"><code>name</code></em>__init_function_1__modprep</code>
   function!</p></div></dd><dt><code class="function">module__<em class="replaceable"><code>name</code></em>__init_function_2</code></dt><dd>called <span class="emphasis"><em>every time</em></span> <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> starts.
  It can be used to bind names to foreign addresses, since the address
  will be different in each invocation of <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>, and is indeed used
  for that purpose by <a href="dffi.html" title="31.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> (e.g., by <a href="dffi.html#def-call-out"><code class="function">FFI:DEF-CALL-OUT</code></a>).
  It can also be used to set parameters of the libraries to which the
  module interfaces, e.g., the <a href="pcre.html" title="32.7. Perl Compatible Regular Expressions.">pcre</a> module
  sets <code class="varname">pcre_malloc</code> and <code class="varname">pcre_free</code>.
</dd></dl></div><p>
<em class="replaceable"><code>name</code></em> is the <a href="modules.html#mod-overview" title="31.2.1. Overview">module name</a>.</p><p>See also <a href="custom-init-fini.html" title="30.1. Customizing CLISP Process&#10;  Initialization and Termination.">Section 30.1, “Customizing <span><strong class="command">CLISP</strong></span> Process
  Initialization and Termination.”</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="modfini"></a>31.2.3. Module finalization.</h3></div></div></div><p>Each module has a finalization function
</p><div class="variablelist"><dl><dt><code class="function">module__<em class="replaceable"><code>name</code></em>__fini_function</code></dt><dd>called before exiting <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>.
</dd></dl></div><p>
<em class="replaceable"><code>name</code></em> is the <a href="modules.html#mod-overview" title="31.2.1. Overview">module name</a>.</p><p>See also <a href="custom-init-fini.html" title="30.1. Customizing CLISP Process&#10;  Initialization and Termination.">Section 30.1, “Customizing <span><strong class="command">CLISP</strong></span> Process
  Initialization and Termination.”</a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="modinfo"></a>31.2.4. Function <a href="modules.html#modinfo" title="31.2.4. Function EXT:MODULE-INFO"><code class="function">EXT:MODULE-INFO</code></a></h3></div></div></div><p>Function <code class="code">(<a href="modules.html#modinfo" title="31.2.4. Function EXT:MODULE-INFO"><code class="function">EXT:MODULE-INFO</code></a> <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;OPTIONAL</code></a> <em class="replaceable"><code>name</code></em>
  <em class="replaceable"><code>verbose</code></em>)</code> allows one to inquire
 about what modules are available in the currently running image.
 When called without arguments, it returns the list of module names,
 starting with “<span class="quote">clisp</span>”.  When <em class="replaceable"><code>name</code></em> is supplied and
 names a module, 3 values are returned - <em class="replaceable"><code>name</code></em>,
 <em class="replaceable"><code>subr-count</code></em>,
 <em class="replaceable"><code>object-count</code></em>.
 When <em class="replaceable"><code>verbose</code></em> is non-<a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><code class="constant">NIL</code></a>, the full list of
 module lisp function names written in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> (<span class="type">Subr</span>s) and
 the full list of internal lisp objects available in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> code
 are additionally returned for the total of 5 values.</p><p>When <em class="replaceable"><code>name</code></em> is <code class="constant">:FFI</code>, returns the list of
 shared libraries opened using <code class="constant">:LIBRARY</code>.
 When <em class="replaceable"><code>verbose</code></em> is non-<a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><code class="constant">NIL</code></a>, return the
 <a href="http://www.lisp.org/HyperSpec/Body/glo_a.html#association_list" target="_top">alist</a> of DLL names and all foreign objects associated with it.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="mod-dynload"></a>31.2.5. Function <a href="modules.html#mod-dynload" title="31.2.5. Function SYS::DYNLOAD-MODULES"><code class="function">SYS::DYNLOAD-MODULES</code></a></h3></div><div><h4 class="subtitle"><span class="plat-dep">Platform Dependent: <span class="plat-dep">Only when compiled <span class="strong"><strong>with</strong></span> configure
  flag <code class="option">--with-dynamic-modules</code>.</span></span></h4></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Dynamic loading does not work on all operating systems
  (<a href="http://www.opengroup.org/onlinepubs/007904975/functions/dlopen.html" target="_top"><code class="function">dlopen</code></a> or equivalent is required).</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p><code class="option">--with-dynamic-modules</code> precludes some
  efficiency optimizations which are enabled by default.</p></div><p>Function <code class="code">(<a href="modules.html#mod-dynload" title="31.2.5. Function SYS::DYNLOAD-MODULES"><code class="function">SYS::DYNLOAD-MODULES</code></a> <em class="replaceable"><code>filename</code></em> ({<em class="replaceable"><code>name</code></em>}+))</code>
 loads a shared object file or library containing a number of named
 external <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> modules.  This facility cannot be used to <a href="http://www.opengroup.org/onlinepubs/007904975/functions/dlopen.html" target="_top"><code class="function">dlopen</code></a> and
 access arbitrary shared libraries.</p><p>External modules for <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> are those which contain a
 <code class="literal">module__<em class="replaceable"><code>name</code></em>__subr_tab</code>, among others.
 This serves to register external functions which operate on
 Lisp-level structures with <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>.</p><p>To use <a href="http://www.opengroup.org/onlinepubs/007904975/functions/dlopen.html" target="_top"><code class="function">dlopen</code></a> with modules, you should add
 <code class="option">-fPIC</code> to the module's compilation options.
 Something like <span><strong class="command">cc -shared -o <em class="replaceable"><code>name</code></em>.so <em class="replaceable"><code>name</code></em>.o</strong></span>
 may be needed to produce the shared object file.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="mod-set-example"></a>31.2.6. Example</h3></div></div></div><p>To link in the <a href="dffi.html" title="31.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> bindings for the <a href="http://www.gnu.org" target="_top">GNU</a>/<a href="http://www.linux.org/" target="_top"><span class="strong"><strong>Linux</strong></span></a> operating
 system, the following steps are needed.  (Step 1 and step 2 need not be
 executed in this order.)</p><div class="procedure"><ol type="1"><li><p class="title"><b>Create a new <a href="modules.html#modset" class="olink">module set</a></b></p><pre class="screen"><code class="prompt">$</code> clisp-link create-module-set linux /<em class="replaceable"><code>somewhere</code></em>/bindings/linux.c</pre></li><li><p class="title"><b>Modify the newly created
  <code class="filename">linux/<a href="modules.html#modset" class="olink"><span><strong class="command">link.sh</strong></span></a></code></b></p><ol type="a"><li><p class="title"><b>add <code class="option">-lm</code> to the libraries</b></p><p>replace </p><pre class="screen">NEW_LIBS="$file_list"</pre><p>
    with </p><pre class="screen">NEW_LIBS="$file_list -lm"</pre></li><li><p class="title"><b>load <code class="filename">linux.fas</code> before saving the
    <a href="image.html" class="olink">memory image</a></b></p><p>replace </p><pre class="screen">TO_LOAD=''</pre><p> with
      </p><pre class="screen">TO_LOAD='/<em class="replaceable"><code>somewhere</code></em>/bindings/linux.fas'</pre></li></ol></li><li><p class="title"><b>Compile <code class="filename">linux.lisp</code>, creating
  <code class="filename">linux.c</code></b></p><pre class="screen"><code class="prompt">$</code> clisp -c /<em class="replaceable"><code>somewhere</code></em>/bindings/linux.lisp</pre></li><li><p class="title"><b>Create a new <a href="modules.html#linkset" class="olink">linking set</a></b></p><pre class="screen"><code class="prompt">$</code> clisp-link add-module-set linux base base+linux</pre></li><li><p class="title"><b>Run and try it</b></p><pre class="screen"><code class="prompt">$</code> base+linux/lisp.run -M base+linux/lispinit.mem -x '(linux:stat "/tmp")'</pre></li></ol></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="module-tools"></a>31.2.7. Module tools</h3></div></div></div><div class="toc"><dl><dt><span class="section"><a href="modules.html#modprep">31.2.7.1. Modprep</a></span></dt><dt><span class="section"><a href="modules.html#clisp-h">31.2.7.2. clisp.h</a></span></dt><dt><span class="section"><a href="modules.html#exporting">31.2.7.3. Exporting</a></span></dt></dl></div><p>There are some tools to facilitate easy module writing.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="modprep"></a>31.2.7.1. Modprep</h4></div></div></div><p>If your module is written in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a>, you can pre-process your
 sources with <a href="modules.html#modprep" title="31.2.7.1. Modprep"><span><strong class="command">modprep.lisp</strong></span></a> in the <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> distribution and define lisp
 functions with the <code class="function">DEFUN</code> macro:
 </p><pre class="programlisting">
DEFUN(MY-PACKAGE:MY-FUNCTION-NAME, arg1 arg2 <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><code class="literal">&amp;KEY</code></a> FOO BAR) {
  if (!boundp(STACK_0)) STACK_0 = fixnum(0); /* BAR */
  if (!boundp(STACK_1)) STACK_1 = fixnum(1); /* FOO */
  pushSTACK(`MY-PACKAGE::SOME-SYMBOL`); /* create a symbol in the package */
  pushSTACK(`#(:THIS :IS :A :VECTOR)`); /* some vector, created once */
  pushSTACK(``MY-PACKAGE::MY-FUNCTION-NAME``); /* double `` means FUNCTION */
  VALUES1(listof(7)); /* cons up a new list and clean up the STACK */
}</pre><p>
Then <code class="code">(MY-PACKAGE:MY-FUNCTION-NAME 'A 12 :FOO T)</code> will
 return <span class="returnvalue">(A 12 T 0 MY-PACKAGE::SOME-SYMBOL #(:THIS
  :IS :A :VECTOR) #&lt;ADD-ON-SYSTEM-FUNCTION
  MY-PACKAGE:MY-FUNCTION-NAME&gt;)</span>
(assuming you <a href="http://www.lisp.org/HyperSpec/Body/fun_export.html" target="_top"><code class="function">EXPORT</code></a>ed <code class="literal">MY-FUNCTION-NAME</code> from
 <strong class="package">“<span class="quote">MY-PACKAGE</span>”</strong>).</p><p>Another useful macros are:
 </p><div class="variablelist"><dl><dt><code class="function">DEFVAR</code></dt><dd>create a GC-visible private object
  </dd><dt><code class="function">DEFFLAGSET</code></dt><dd>define a <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> function which will remove
     several flag arguments from the <a href="vm.html" class="olink"><code class="literal">STACK</code></a> and return the combined flag
     value</dd><dt><code class="function">DEFCHECKER</code></dt><dd>define a <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> function which will check that
     its argument is one of the specified keywords and return the value
     of the appropriate <a href="http://gcc.gnu.org/onlinedocs/cpp/" target="_top"><span><strong class="command">cpp</strong></span></a> macro</dd></dl></div><p>See <code class="filename">modules/syscalls</code> and other included
 modules for more examples and file <a href="modules.html#modprep" title="31.2.7.1. Modprep"><span><strong class="command">modprep.lisp</strong></span></a> for full documentation.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>If you manipulate Lisp objects, you need to watch for
  <a href="gc-safety.html" title="34.5. The burden of garbage-collection upon the rest of CLISP">GC-safety</a>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="clisp-h"></a>31.2.7.2. clisp.h</h4></div></div></div><p>If your module is written in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a>, you will probably want
 to <code class="literal">#include "clisp.h"</code> to access <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> objects.
 You will certainly need to read <a href="modules.html#clisp-h" title="31.2.7.2. clisp.h"><code class="filename">"clisp.h"</code></a> and the code in
 <a href="modules.html#included-modules" title="31.2.8. Modules included in the source distribution.">included modules</a>, but here are
 some important hints that you will need to keep in mind:
</p><div class="itemizedlist"><ul type="disc"><li>Lisp objects have type <span class="type">object</span>.
 </li><li>Variables of this type are invalidated by
   <a href="gc-safety.html" title="34.5. The burden of garbage-collection upon the rest of CLISP">memory allocation</a> and must be saved
   on the <a href="vm.html" class="olink"><code class="literal">STACK</code></a> using macros <code class="function">pushSTASK()</code>,
   <code class="function">popSTACK()</code> and <code class="function">skipSTACK()</code>.
 </li><li>Access object slots using the
   appropriate <code class="function">TheFoo()</code> macro, e.g.,
   <code class="function">TheCons(my_cons)-&gt;Car</code>, but first check the
   type with <code class="function">consp()</code>.</li><li>Arguments are passed on the <a href="vm.html" class="olink"><code class="literal">STACK</code></a>, as illustrated
   in the <a href="modules.html#modprep" title="31.2.7.1. Modprep">above example</a>.</li><li>Wrap your system calls in
   <code class="literal">begin_system_call()</code>/<code class="literal">end_system_call()</code>
   pairs.  These macros, defined in <a href="modules.html#clisp-h" title="31.2.7.2. clisp.h"><code class="filename">"clisp.h"</code></a>, save and restore
   registers used by <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> which could be clobbered by a system call.
 </li></ul></div><p>
</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="exporting"></a>31.2.7.3. Exporting</h4></div></div></div><p>If your module uses <a href="dffi.html" title="31.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> to interface to a <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><strong class="command">C</strong></span></a> library,
 you might want to make your module package
 <a href="pack-dict.html#make-pack" title="11.5.1. Function MAKE-PACKAGE">case-sensitive</a> and use
 <a href="src-files.html#exporting-lisp"><code class="filename">exporting.lisp</code></a> in the <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> distribution to make <a href="dffi.html" title="31.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> forms
 and <a href="http://www.lisp.org/HyperSpec/Body/mac_defun.html" target="_top"><code class="function">DEFUN</code></a>, <a href="http://www.lisp.org/HyperSpec/Body/mac_defmacro.html" target="_top"><code class="function">DEFMACRO</code></a> at al export the symbols they define.
 See <code class="filename">modules/netica</code>, <code class="filename">modules/matlab</code>
 and <code class="filename">modules/bindings/*</code> for examples.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="included-modules"></a>31.2.8. Modules included in the source distribution.</h3></div></div></div><div class="toc"><dl><dt><span class="section"><a href="modules.html#base-modules">31.2.8.1. Base and Full Modules</a></span></dt></dl></div><p>The following modules come with the <span class="emphasis"><em>source</em></span>
 distribution of <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> (but are not necessarily built in a
 particular <span class="emphasis"><em>binary</em></span> distribution):</p><div class="variablelist"><dl><dt>bindings</dt><dd><p>Call the operating system functions from <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>.
    The following platforms are supported:
   </p><div class="itemizedlist"><ul type="disc"><li><a href="http://www.linux.org/" target="_top"><span class="strong"><strong>Linux</strong></span></a>/<a href="http://www.gnu.org" target="_top">GNU</a> <a href="http://www.gnu.org/software/libc/" target="_top">libc</a></li><li><a href="http://winehq.com/" target="_top"><span class="strong"><strong>Win32</strong></span></a></li></ul></div></dd><dt><a href="http://www.cliki.net/CLX" target="_top"><span><strong class="command">CLX</strong></span></a></dt><dd><p>Call
    <a href="http://www.the-labs.com/X11/XLib-Manual/" target="_top">Xlib</a>
    functions from <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>.  Two implementations are supplied:
   </p><div class="itemizedlist"><ul type="disc"><li>mit-clx, from MIT
      <a href="ftp://ftp.x.org/R5contrib/CLX.R5.02.tar.Z" target="_top">ftp://ftp.x.org/R5contrib/CLX.R5.02.tar.Z</a>
      - the standard implementation</li><li>new-clx, by <span class="author"><span class="firstname">Gilbert</span> <span class="surname">Baumann</span></span>
      - faster, with additional features, but not quite complete yet.
    </li></ul></div></dd><dt><a href="oracle.html" title="32.11. Oracle Interface">oracle</a></dt><dd>Access
    <a href="http://www.oracle.com/" target="_top">Oracle</a> from <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>;
    by <span class="author"><span class="firstname">John</span> <span class="surname">Hinsdale</span></span>.</dd><dt><a href="fastcgi.html" title="32.12. The FastCGI Interface">fastcgi</a></dt><dd>Access
    <a href="http://www.fastcgi.com/" target="_top">FastCGI</a> from <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>;
    by <span class="author"><span class="firstname">John</span> <span class="surname">Hinsdale</span></span>.</dd><dt><a href="matlab.html" title="32.1. Matlab Interface">matlab</a></dt><dd>Do matrix computations via
    <a href="http://www.mathworks.com/products/matlab/" target="_top">MATLAB</a>.
 </dd><dt><a href="netica.html" title="32.2. Netica Interface">netica</a></dt><dd>Work with Bayesian belief networks and influence
    diagrams using <a href="http://norsys.com/netica_c_api.htm" target="_top">Netica C API</a>.</dd><dt><a href="postgresql.html" title="32.8. PostgreSQL Database Access.">postgresql</a></dt><dd>Access <a href="http://www.PostgreSQL.org/" target="_top">PostgreSQL</a> from <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a>.
  </dd><dt>queens</dt><dd>Compute the number of solutions to the <em class="replaceable"><code>n</code></em>-queens
    problem on a <em class="replaceable"><code>n*n</code></em> checkboard (a toy
    example for the users to explore the <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> <a href="modules.html" title="31.2. External Modules">module</a> system).
 </dd><dt><a href="dir-key.html" title="32.3. Directory Access">dirkey</a></dt><dd>Directory Access (LDAP, <a href="http://winehq.com/" target="_top"><span class="strong"><strong>Win32</strong></span></a> registry etc).
 </dd><dt><a href="berkeley-db.html" title="32.4. Berkeley DB access.">berkeley-db</a></dt><dd><a href="http://www.sleepycat.com/docs/index.html" target="_top">Berkeley DB from Sleepycat Software</a> interface.
 </dd><dt><a href="regexp-mod.html" title="32.5. CLISP “REGEXP” module">regexp</a></dt><dd>The <a href="regexp.html" target="_top">POSIX Regular
     Expressions</a> matching, compiling, executing.
    See <a href="modules.html#base-modules" title="31.2.8.1. Base and Full Modules">Section 31.2.8.1, “Base and Full Modules”</a>.</dd><dt><a href="pari.html" title="32.6. Computer Algebra System PARI.">pari</a></dt><dd>Interface to the computer algebra system <a href="http://pari.math.u-bordeaux.fr/" target="_top">PARI</a>.
 </dd><dt><a href="pcre.html" title="32.7. Perl Compatible Regular Expressions.">pcre</a></dt><dd>The <a href="http://www.pcre.org/" target="_top">Perl
     Compatible Regular Expressions</a> matching, compiling,
    executing.</dd><dt><a href="i18n-mod.html" title="32.9. Internationalization of User Programs">i18n</a></dt><dd>Internationalization of User Programs.
    See <a href="modules.html#base-modules" title="31.2.8.1. Base and Full Modules">Section 31.2.8.1, “Base and Full Modules”</a>.</dd><dt><a href="syscalls.html" title="32.10. System Calls">syscalls</a></dt><dd>Use some system calls in a platform-independent way.
    See <a href="modules.html#base-modules" title="31.2.8.1. Base and Full Modules">Section 31.2.8.1, “Base and Full Modules”</a>.</dd><dt><a href="wildcard.html" title="32.14. The Wildcard Module">wildcard</a></dt><dd>Shell (<a href="http://www.opengroup.org/onlinepubs/007904975/utilities/sh.html" target="_top"><span><strong class="command">/bin/sh</strong></span></a>) globbing (<a href="http://www.opengroup.org/onlinepubs/007904975/utilities/xcu_chap02.html#tag_02_13" target="_top">Pathname Matching</a>).
 </dd><dt><a href="rawsock.html" title="32.13. Raw Socket Access.">rawsock</a></dt><dd>Raw socket access.</dd><dt><a href="zlib.html" title="32.15. ZLIB Interface">zlib</a></dt><dd>Compress <a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><code class="classname">VECTOR</code></a>s using
    <a href="http://www.zlib.org" target="_top">ZLIB</a>.
 </dd></dl></div><p>To use modules, read <code class="filename">unix/INSTALL</code> and build
 <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> in directory <code class="filename">build-dir</code> with, e.g.,</p><pre class="screen">
  <code class="prompt">$</code> ./configure --with-module=pcre --with-module=clx/new-clx --build build-dir
</pre><p>then run it with
</p><pre class="screen"><code class="prompt">$</code> ./build-dir/clisp <code class="option"><a href="clisp.html#opt-link-set" class="olink">-K</a></code> full</pre><p>
This will create a <a href="modules.html#base-modules" class="olink"><span><strong class="command">base</strong></span></a> <a href="modules.html#linkset" class="olink">linking set</a> with modules i18n, regexp and
syscalls; and a <a href="modules.html#base-modules" class="olink"><span><strong class="command">full</strong></span></a> <a href="modules.html#linkset" class="olink">linking set</a> with modules pcre and new/clx in
addition to the 3 <a href="modules.html#base-modules" title="31.2.8.1. Base and Full Modules">base modules</a>.</p><p>See <a href="ext-modules.html" title="Chapter 32. Extensions Implemented as Modules">Chapter 32, <i>Extensions Implemented as Modules</i></a>
 for individual module documentation.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="base-modules"></a>31.2.8.1. Base and Full Modules</h4></div></div></div><p>Note that the default binary distribution includes the following
  modules in <span class="emphasis"><em>both</em></span> <a href="modules.html#base-modules" class="olink"><span><strong class="command">base</strong></span></a> <span class="strong"><strong>and</strong></span> <a href="modules.html#base-modules" class="olink"><span><strong class="command">full</strong></span></a> <a href="modules.html#linkset" class="olink">linking set</a>s:
  </p><table class="simplelist" border="0" summary="Simple list"><tr><td><a href="i18n-mod.html" title="32.9. Internationalization of User Programs">i18n</a></td></tr><tr><td><a href="regexp-mod.html" title="32.5. CLISP “REGEXP” module">regexp</a></td></tr><tr><td><a href="syscalls.html" title="32.10. System Calls">syscalls</a></td></tr></table><p>The composition of the <a href="modules.html#base-modules" class="olink"><span><strong class="command">full</strong></span></a> <a href="modules.html#linkset" class="olink">linking set</a> depends on the platform
  and on the vendor preferences.</p></div></div></div><div class="bookinfo"><hr width="100%" /><table width="100%" summary="impnotes meta info"><th><td align="left">These notes document <a href="http://clisp.cons.org" target="_top"><span><strong class="command">CLISP</strong></span></a> version 2.34.</td><td align="right">Last modified: 2005-07-20</td></th></table></div><div class="custom-footer"><hr width="100%" /><table width="100%"><tr><td align="left"><a href="http://clisp.cons.org"><img src="clisp.png" width="48" height="48" alt="[CLISP home]" /></a></td><td align="center"><a href="http://www.gnu.org"><img src="http://www.gnu.org/graphics/gnubanner.jpg" width="468" height="60" alt="[Come and see what GNU creates for YOU]" /></a></td><td align="right"><a href="http://sourceforge.net"><img width="125" height="37" alt="[SourceForge]" src="http://sflogo.sourceforge.net/sflogo.php?group_id=1355&amp;type=2&amp;page=modules" /></a></td></tr></table></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="screen.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="ext-platform.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="dffi.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">31.1. Random Screen Access </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 31.3. The Foreign Function Call Facility</td></tr></table></div></body></html>
