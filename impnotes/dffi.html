<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>30.3. Extensions-2.3. The Foreign Function Call Facility</title><link rel="stylesheet" href="impnotes.css" type="text/css" /><link rev="made" href="mailto:clisp-list@sf.net" /><meta name="generator" content="DocBook XSL Stylesheets V1.65.1" /><link rel="home" href="index.html" title="Implementation Notes for GNU CLISP." /><link rel="up" href="platform.html" title="Chapter 30. Extensions-2: Platform specific Extensions" /><link rel="previous" href="modules.html" title="30.2. Extensions-2.2. External Modules" /><link rel="next" href="affi.html" title="30.4. Extensions-2.4. The Amiga Foreign Function Call Facility" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">30.3. Extensions-2.3. The Foreign Function Call Facility</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="modules.html">Prev</a> </td><th width="60%" align="center">Chapter 30. Extensions-2: Platform specific Extensions</th><td width="20%" align="right"> <a accesskey="n" href="affi.html">Next</a></td></tr></table><hr /></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="dffi"></a>30.3. Extensions-2.3. The Foreign Function Call Facility</h2></div><div><h3 class="subtitle">Platform dependent: many <a href="http://www.UNIX-systems.org/online.html" target="_top"><strong>UNIX</strong></a>, <a href="http://www.willows.com/" target="_top"><strong>Win32</strong></a> platforms
only.</h3></div></div><div></div></div><div class="toc"><dl><dt><span class="section"><a href="dffi.html#dffi-overview">30.3.1. Overview</a></span></dt><dt><span class="section"><a href="dffi.html#dffi-types">30.3.2. (Foreign) <span><b class="command">C</b></span> types</a></span></dt><dt><span class="section"><a href="dffi.html#c-flavor">30.3.3. The choice of the <span><b class="command">C</b></span> flavor.</a></span></dt><dt><span class="section"><a href="dffi.html#dffi-variables">30.3.4. Foreign variables</a></span></dt><dt><span class="section"><a href="dffi.html#dffi-places">30.3.5. Operations on foreign places</a></span></dt><dt><span class="section"><a href="dffi.html#dffi-functions">30.3.6. Foreign functions</a></span></dt><dt><span class="section"><a href="dffi.html#allocation">30.3.7. Argument and result passing conventions</a></span></dt><dt><span class="section"><a href="dffi.html#param-mode">30.3.8. Parameter Mode</a></span></dt><dt><span class="section"><a href="dffi.html#dffi-examples">30.3.9. Examples</a></span></dt></dl></div><p>A foreign function description is written as a Lisp file, and when
 compiled it produces a <tt class="filename">#P".c"</tt> file which is then compiled by the
 <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> compiler and may be linked together with
 <tt class="filename">lisp.a</tt>.</p><p>All symbols relating to the foreign function interface are
 exported from the package <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a>.  To use them,
 <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/fun_use-package.html" target="_top"><tt class="function">USE-PACKAGE</tt></a> "FFI")</tt>.</p><p>Special <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> forms may appear anywhere in the Lisp file.</p><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="dffi-overview"></a>30.3.1. Overview</h3></div></div><div></div></div><p>These are the special <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> forms.  We have taken a pragmatic
 approach: the only foreign languages we support for now are <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>
 and ANSI <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>.</p><div class="variablelist"><p class="title"><b>special <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> forms; <i class="replaceable"><tt>name</tt></i> is any Lisp
   <a href="http://www.lisp.org/HyperSpec/Body/syscla_symbol.html" target="_top"><tt class="classname">SYMBOL</tt></a>; <i class="replaceable"><tt>c-name</tt></i> is a <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a>.</b></p><dl><dt><a id="def-c-type"></a><tt class="sexp">(<a href="dffi.html#def-c-type"><tt class="function">FFI:DEF-C-TYPE</tt></a> <i class="replaceable"><tt>name</tt></i> <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>This form makes <i class="replaceable"><tt>name</tt></i> a shortcut for <i class="replaceable"><tt>c-type</tt></i>.
   Note that <i class="replaceable"><tt>c-type</tt></i> may already refer to name.
   Forward declarations of types are not possible, however.
</dd><dt><a id="def-c-var"></a><tt class="sexp">(<a href="dffi.html#def-c-var"><tt class="function">FFI:DEF-C-VAR</tt></a> <i class="replaceable"><tt>name</tt></i>
   {<i class="replaceable"><tt>option</tt></i>}*)</tt></dt><dd><p>This form defines a <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a>.
   <i class="replaceable"><tt>name</tt></i> is the Lisp name, a regular Lisp <a href="http://www.lisp.org/HyperSpec/Body/syscla_symbol.html" target="_top"><tt class="classname">SYMBOL</tt></a>.</p><div class="variablelist"><a id="def-c-var-opts"></a><p class="title"><b>Options for <a href="dffi.html#def-c-var"><tt class="function">FFI:DEF-C-VAR</tt></a></b></p><dl><dt><tt class="sexp">(<tt class="constant">:NAME</tt>
      <i class="replaceable"><tt>c-name</tt></i>)</tt></dt><dd>specifies the name as seen from <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>, as a
      string.  If not specified, it is derived from the print name of
      the Lisp name.</dd><dt><tt class="sexp">(<tt class="constant">:TYPE</tt>
      <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>specifies the variable's foreign type.
   </dd><dt><tt class="sexp">(<tt class="constant">:READ-ONLY</tt>
      <a href="http://www.lisp.org/HyperSpec/Body/typ_boolean.html" target="_top"><tt class="classname">BOOLEAN</tt></a>)</tt></dt><dd>If this option is specified and non-<a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>,
      it will be impossible to change the variable's value from within
      Lisp (using <a href="http://www.lisp.org/HyperSpec/Body/spefor_setq.html" target="_top"><tt class="function">SETQ</tt></a> or similar).</dd><dt><tt class="sexp">(:ALLOC
      <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>)</tt></dt><dd>This option can be either <tt class="constant">:NONE</tt> or
      <tt class="constant">:MALLOC-FREE</tt> and defaults to <tt class="constant">:NONE</tt>.  If it is
      <tt class="constant">:MALLOC-FREE</tt>, any values of type <a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a>, <a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a>,
      <a href="dffi.html#c-ptr-null"><span class="type">FFI:C-PTR-NULL</span></a>, <a href="dffi.html#c-array-ptr"><span class="type">FFI:C-ARRAY-PTR</span></a> within the foreign value are assumed
      to be pointers to <a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a>-allocated storage, and when <a href="http://www.lisp.org/HyperSpec/Body/spefor_setq.html" target="_top"><tt class="function">SETQ</tt></a>
      replaces an old value by a new one, the old storage is freed using
      <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a> and the new storage allocated using <a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a>.  If it is
      <tt class="constant">:NONE</tt>, <a href="http://www.lisp.org/HyperSpec/Body/spefor_setq.html" target="_top"><tt class="function">SETQ</tt></a> assumes that the pointers point to good storage
      (not <tt class="constant">NULL</tt>!) and overwrites the old values by the new ones.
      This is dangerous (just think of overwriting a string with a
      longer one or storing some data in a <tt class="constant">NULL</tt> pointer...)  and
      deprecated.</dd><dt><tt class="sexp">(<tt class="constant">:LIBRARY</tt>
      <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a>)</tt></dt><dd>Specifies the (optional) dynamic library
      which contains the variable.
 </dd></dl></div></dd><dt><a id="def-call-out"></a><tt class="sexp">(<a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a>
              <i class="replaceable"><tt>name</tt></i> {<i class="replaceable"><tt>option</tt></i>}*)</tt></dt><dd><p>This form defines a named call-out function (a
 foreign function called from Lisp: control flow temporarily leaves Lisp).
 </p><div class="variablelist"><a id="def-call-out-opts"></a><p class="title"><b>Options for <a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a></b></p><dl><dt><tt class="sexp">(<tt class="constant">:NAME</tt> <i class="replaceable"><tt>c-name</tt></i>)</tt></dt><dd>Any Lisp function call to <tt class="function">#'<i class="replaceable"><tt>name</tt></i></tt>
  is redirected to call the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function <i class="replaceable"><tt>c-name</tt></i>.
</dd><dt><tt class="sexp">(<tt class="constant">:ARGUMENTS</tt>
   {(<i class="replaceable"><tt>argument</tt></i> <i class="replaceable"><tt>c-type</tt></i> [<a href="dffi.html#param-mode" title="30.3.8. Parameter Mode"><i class="replaceable"><tt>PARAM-MODE</tt></i></a> [<a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>]])}*)</tt><br /><tt class="sexp">(<tt class="constant">:RETURN-TYPE</tt> <i class="replaceable"><tt>c-type</tt></i>
   [<a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>])</tt></dt><dd>Argument list and return value, see
   <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions">Section 30.3.7, “Argument and result passing conventions”</a> and <a href="dffi.html#param-mode" title="30.3.8. Parameter Mode">Section 30.3.8, “Parameter Mode”</a>.
</dd><dt><tt class="sexp">(<a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor."><tt class="constant">:LANGUAGE</tt></a> <i class="replaceable"><tt>language</tt></i>)</tt></dt><dd>See <a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor.">Section 30.3.3, “The choice of the <span><b class="command">C</b></span> flavor.”</a>.
</dd><dt><tt class="sexp">(:BUILT-IN
   <a href="http://www.lisp.org/HyperSpec/Body/typ_boolean.html" target="_top"><tt class="classname">BOOLEAN</tt></a>)</tt></dt><dd>When the function is a <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> built-in, the full
   prototype will be output (unless suppressed by <a href="dffi.html#ffi-extern-output"><tt class="varname">FFI:*OUTPUT-C-FUNCTIONS*</tt></a>).
</dd><dt><tt class="sexp">(<tt class="constant">:LIBRARY</tt>
   <a href="http://www.lisp.org/HyperSpec/Body/syscla_string.html" target="_top"><tt class="classname">STRING</tt></a>)</tt></dt><dd>Specifies the (optional) dynamic library
  which contains the variable.
</dd></dl></div></dd><dt><a id="def-call-in"></a><tt class="sexp">(<a href="dffi.html#def-call-in"><tt class="function">FFI:DEF-CALL-IN</tt></a>
              <i class="replaceable"><tt>name</tt></i> {<i class="replaceable"><tt>option</tt></i>}*)</tt></dt><dd><p>This form defines a named call-in function (i.e., a Lisp
 function called from the foreign language: control flow temporary
 enters Lisp)</p><div class="variablelist"><a id="def-call-in-opts"></a><p class="title"><b>Options for <a href="dffi.html#def-call-in"><tt class="function">FFI:DEF-CALL-IN</tt></a></b></p><dl><dt><tt class="sexp">(<tt class="constant">:NAME</tt> <i class="replaceable"><tt>c-name</tt></i>)</tt></dt><dd>Any <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function call to the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function
   <i class="replaceable"><tt>c-name</tt></i> is redirected to call the <a href="http://www.lisp.org" target="_top"><span><b class="command">Common Lisp</b></span></a> function
   <tt class="function">#'<i class="replaceable"><tt>name</tt></i></tt>.</dd><dt><tt class="sexp">(<tt class="constant">:ARGUMENTS</tt>
   {(<i class="replaceable"><tt>argument</tt></i> <i class="replaceable"><tt>c-type</tt></i> [<a href="dffi.html#param-mode" title="30.3.8. Parameter Mode"><i class="replaceable"><tt>PARAM-MODE</tt></i></a> [<a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>]])}*)</tt><br /><tt class="sexp">(<tt class="constant">:RETURN-TYPE</tt> <i class="replaceable"><tt>c-type</tt></i>
   [<a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>])</tt></dt><dd>Argument list and return value, see
   <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions">Section 30.3.7, “Argument and result passing conventions”</a> and <a href="dffi.html#param-mode" title="30.3.8. Parameter Mode">Section 30.3.8, “Parameter Mode”</a>.
</dd><dt><tt class="sexp">(<a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor."><tt class="constant">:LANGUAGE</tt></a> <i class="replaceable"><tt>language</tt></i>)</tt></dt><dd>See <a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor.">Section 30.3.3, “The choice of the <span><b class="command">C</b></span> flavor.”</a>.
</dd></dl></div></dd><dt><a id="def-c-call-out"></a><tt class="sexp">(<a href="dffi.html#def-c-call-out"><tt class="function">FFI:DEF-C-CALL-OUT</tt></a>
        <i class="replaceable"><tt>name</tt></i> {<i class="replaceable"><tt>option</tt></i>}*)</tt></dt><dd>This is equivalent to <a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a> with
   <a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor."><tt class="constant">:LANGUAGE</tt></a> <tt class="constant">:STDC</tt>.  <span class="emphasis"><em>deprecated</em></span>.
   </dd><dt><a id="def-c-call-in"></a><tt class="sexp">(<a href="dffi.html#def-c-call-in"><tt class="function">FFI:DEF-C-CALL-IN</tt></a>
        <i class="replaceable"><tt>name</tt></i> {<i class="replaceable"><tt>option</tt></i>}*)</tt></dt><dd>This is equivalent to <a href="dffi.html#def-call-in"><tt class="function">FFI:DEF-CALL-IN</tt></a> with
   <a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor."><tt class="constant">:LANGUAGE</tt></a> <tt class="constant">:STDC</tt>.  <span class="emphasis"><em>deprecated</em></span>.
   </dd><dt><a id="def-c-struct"></a><tt class="sexp">(<a href="dffi.html#def-c-struct"><tt class="function">FFI:DEF-C-STRUCT</tt></a>
   <i class="replaceable"><tt>name</tt></i> (<i class="replaceable"><tt>symbol</tt></i> <i class="replaceable"><tt>c-type</tt></i>)*)</tt></dt><dd><p>This form defines <i class="replaceable"><tt>name</tt></i> to be both a
  <a href="http://www.lisp.org/HyperSpec/Body/syscla_structure-class.html" target="_top"><tt class="classname">STRUCTURE-CLASS</tt></a> and a foreign <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type with the given slots.
  <i class="replaceable"><tt>name</tt></i> is a <a href="http://www.lisp.org/HyperSpec/Body/syscla_symbol.html" target="_top"><tt class="classname">SYMBOL</tt></a> (structure name) or a <a href="http://www.lisp.org/HyperSpec/Body/syscla_list.html" target="_top"><tt class="classname">LIST</tt></a> whose <a href="http://www.lisp.org/HyperSpec/Body/acc_firstcm_s_inthcm_tenth.html" target="_top"><tt class="function">FIRST</tt></a>
  element is the structure name and the <a href="http://www.lisp.org/HyperSpec/Body/acc_rest.html" target="_top"><tt class="function">REST</tt></a> is options.
  Two options are supported at this time:
  </p><div class="variablelist"><a id="def-c-struct-opts"></a><p class="title"><b>Options for <a href="dffi.html#def-c-struct"><tt class="function">FFI:DEF-C-STRUCT</tt></a></b></p><dl><dt><a id="def-c-struct-typedef"></a><tt class="constant">:TYPEDEF</tt></dt><dd>means that the name of this structure is a
      <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type defined with <tt class="function">typedef</tt>
      elsewhere.</dd><dt><a id="def-c-struct-external"></a><tt class="constant">:EXTERNAL</tt></dt><dd>means that this structure is defined in a
      <tt class="filename">#P".c"</tt> file that you include with, e.g.,
      <tt class="sexp">(<a href="dffi.html#c-lines"><tt class="function">FFI:C-LINES</tt></a> "#include &lt;filename.h&gt;")</tt>.
  </dd></dl></div><p>
  These options determine how the struct is written to the <tt class="filename">#P".c"</tt>.
</p></dd><dt><a id="def-c-enum"></a><tt class="sexp">(<a href="dffi.html#def-c-enum"><tt class="function">FFI:DEF-C-ENUM</tt></a>
   <i class="replaceable"><tt>name</tt></i> {<i class="replaceable"><tt>symbol</tt></i> | (<i class="replaceable"><tt>symbol</tt></i> [<i class="replaceable"><tt>value</tt></i>])}*)</tt></dt><dd><p>This form defines <i class="replaceable"><tt>symbol</tt></i>s
  as constants, similarly to the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> declaration <span class="type">enum {
  <i class="replaceable"><tt>symbol</tt></i> [= <i class="replaceable"><tt>value</tt></i>], ... };</span></p><p>You can use
 <tt class="sexp">(<tt class="function">FFI:ENUM-FROM-VALUE</tt> <i class="replaceable"><tt>name</tt></i>
  <i class="replaceable"><tt>value</tt></i>)</tt> and
 <tt class="sexp">(<tt class="function">FFI:ENUM-TO-VALUE</tt> <i class="replaceable"><tt>name</tt></i>
  <i class="replaceable"><tt>symbol</tt></i>)</tt> to convert between the numeric and symbolic
 representations (of course, the latter function boils down to
 <a href="http://www.lisp.org/HyperSpec/Body/acc_symbol-value.html" target="_top"><tt class="function">SYMBOL-VALUE</tt></a> plus a check that the <i class="replaceable"><tt>symbol</tt></i> is indeed a constant
 defined in the <a href="dffi.html#def-c-enum"><tt class="function">FFI:DEF-C-ENUM</tt></a> <i class="replaceable"><tt>name</tt></i>).</p></dd><dt><a id="c-lines"></a><tt class="sexp">(<a href="dffi.html#c-lines"><tt class="function">FFI:C-LINES</tt></a>
  <i class="replaceable"><tt>format-string</tt></i> {<i class="replaceable"><tt>argument</tt></i>}*)</tt></dt><dd>This form outputs the string <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/fun_format.html" target="_top"><tt class="function">FORMAT</tt></a> <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> <i class="replaceable"><tt>format-string</tt></i>
    {<i class="replaceable"><tt>argument</tt></i>}*)</tt> to the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> output file.
   This is a rarely needed low-level facility.
 </dd><dt><a id="element"></a><tt class="sexp">(<a href="dffi.html#element"><tt class="function">FFI:ELEMENT</tt></a>
     <i class="replaceable"><tt>c-place</tt></i> <i class="replaceable"><tt>index<sub>1</sub></tt></i> ...
     <i class="replaceable"><tt>index<sub>n</sub></tt></i>)</tt></dt><dd>Array element: If <i class="replaceable"><tt>c-place</tt></i> is of foreign type
  <tt class="type">(<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a> <i class="replaceable"><tt>c-type</tt></i>
  (<i class="replaceable"><tt>dim<sub>1</sub></tt></i>
  ... <i class="replaceable"><tt>dim<sub>n</sub></tt></i>))</tt>
  and 0 ≤ <i class="replaceable"><tt>index<sub>1</sub></tt></i>
  &lt; <i class="replaceable"><tt>dim<sub>1</sub></tt></i>, ..., 0
  ≤ <i class="replaceable"><tt>index<sub>n</sub></tt></i> &lt;
  <i class="replaceable"><tt>dim<sub>n</sub></tt></i>, this will be
  the <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> corresponding to <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/acc_aref.html" target="_top"><tt class="function">AREF</tt></a>
  <i class="replaceable"><tt>c-place</tt></i> <i class="replaceable"><tt>index<sub>1</sub></tt></i>
  ... <i class="replaceable"><tt>index<sub>n</sub></tt></i>)</tt> or
  <tt class="varname"><i class="replaceable"><tt>c-place</tt></i>[<i class="replaceable"><tt>index<sub>1</sub></tt></i>]...[<i class="replaceable"><tt>index<sub>n</sub></tt></i>]</tt>.
  It is a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> of type <i class="replaceable"><tt>c-type</tt></i>.
  If <i class="replaceable"><tt>c-place</tt></i> is of foreign type <tt class="type">(<a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a>
  <i class="replaceable"><tt>c-type</tt></i> <i class="replaceable"><tt>dim</tt></i>)</tt> and 0 ≤
  <i class="replaceable"><tt>index</tt></i> &lt; <i class="replaceable"><tt>dim</tt></i>,
  this will be the <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> corresponding to <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/acc_aref.html" target="_top"><tt class="function">AREF</tt></a>
  <i class="replaceable"><tt>c-place</tt></i> <i class="replaceable"><tt>index</tt></i>)</tt> or
  <tt class="varname"><i class="replaceable"><tt>c-place</tt></i>[<i class="replaceable"><tt>index</tt></i>]</tt>.
  It is a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> of type <i class="replaceable"><tt>c-type</tt></i>.
</dd><dt><a id="deref"></a><tt class="sexp">(<a href="dffi.html#deref"><tt class="function">FFI:DEREF</tt></a>
                <i class="replaceable"><tt>c-place</tt></i>)</tt></dt><dd>Dereference pointer: If
  <i class="replaceable"><tt>c-place</tt></i> is of foreign type
  <tt class="type">(<a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a> <i class="replaceable"><tt>c-type</tt></i>)</tt> or
  <tt class="type">(<a href="dffi.html#c-ptr-null"><span class="type">FFI:C-PTR-NULL</span></a> <i class="replaceable"><tt>c-type</tt></i>)</tt>,
  this will be the <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> the pointer points to.
  It is a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> of type <i class="replaceable"><tt>c-type</tt></i>.
  For <tt class="type">(<a href="dffi.html#c-ptr-null"><span class="type">FFI:C-PTR-NULL</span></a> <i class="replaceable"><tt>c-type</tt></i>)</tt>,
  the <i class="replaceable"><tt>c-place</tt></i> may not be <tt class="constant">NULL</tt>.
</dd><dt><a id="slot"></a><tt class="sexp">(<a href="dffi.html#slot"><tt class="function">FFI:SLOT</tt></a>
       <i class="replaceable"><tt>c-place</tt></i> <i class="replaceable"><tt>slot-name</tt></i>)</tt></dt><dd>Struct or union component: If <i class="replaceable"><tt>c-place</tt></i> is of
  foreign type <tt class="type">(<a href="dffi.html#c-struct"><span class="type">FFI:C-STRUCT</span></a> <i class="replaceable"><tt>class</tt></i>
  ... (<i class="replaceable"><tt>slot-name</tt></i> <i class="replaceable"><tt>c-type</tt></i>) ...)</tt> or
  of type <tt class="type">(<a href="dffi.html#c-union"><span class="type">FFI:C-UNION</span></a>
  ... (<i class="replaceable"><tt>slot-name</tt></i> <i class="replaceable"><tt>c-type</tt></i>) ...)</tt>,
  this will be of type <i class="replaceable"><tt>c-type</tt></i>.
  </dd><dt><a id="cast"></a><tt class="sexp">(<a href="dffi.html#cast"><tt class="function">FFI:CAST</tt></a>
           <i class="replaceable"><tt>c-place</tt></i> <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>Type change: A <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> denoting the same memory
  locations as the original <i class="replaceable"><tt>c-place</tt></i>, but of type <i class="replaceable"><tt>c-type</tt></i>.
 </dd><dt><a id="offset"></a><tt class="sexp">(<a href="dffi.html#offset"><tt class="function">FFI:OFFSET</tt></a>
           <i class="replaceable"><tt>c-place</tt></i> <i class="replaceable"><tt>offset</tt></i> <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>Type change and displacement: return a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> denoting
  a memory locations displaced from the original <i class="replaceable"><tt>c-place</tt></i> by an
  <i class="replaceable"><tt>offset</tt></i> counted in bytes, with type <i class="replaceable"><tt>c-type</tt></i>.
  This can be used to resize an array, e.g. of <i class="replaceable"><tt>c-type</tt></i>
  <tt class="type">(<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a> <span class="type">uint16</span> <i class="replaceable"><tt>n</tt></i>)</tt>
  via <tt class="sexp">(<a href="dffi.html#offset"><tt class="function">FFI:OFFSET</tt></a> <i class="replaceable"><tt>c-place</tt></i> 0
  '(<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a> <span class="type">uint16</span> <i class="replaceable"><tt>k</tt></i>))</tt>.
 </dd><dt><a id="c-var-addr"></a><tt class="sexp">(<a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a>
           <i class="replaceable"><tt>c-place</tt></i>)</tt></dt><dd>Return the address of <i class="replaceable"><tt>c-place</tt></i> as a Lisp object of
  type <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>.  This is useful as an argument
  to foreign functions expecting a parameter of <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a>.
 </dd><dt><a id="c-var-object"></a><tt class="sexp">(<a href="dffi.html#c-var-object"><tt class="function">FFI:C-VAR-OBJECT</tt></a>
   <i class="replaceable"><tt>c-place</tt></i>)</tt></dt><dd>Return the <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> object underlying the
   <i class="replaceable"><tt>c-place</tt></i>.  This is also an acceptable argument type to a <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a>
   declaration.</dd><dt><a id="typeof"></a><tt class="sexp">(<a href="dffi.html#typeof"><tt class="function">FFI:TYPEOF</tt></a>
    <i class="replaceable"><tt>c-place</tt></i>)</tt></dt><dd>returns the <i class="replaceable"><tt>c-type</tt></i> corresponding to the <i class="replaceable"><tt>c-place</tt></i>.
</dd><dt><a id="sizeof"></a><tt class="sexp">(<a href="dffi.html#sizeof"><tt class="function">FFI:SIZEOF</tt></a> <i class="replaceable"><tt>c-type</tt></i>)</tt><br /><tt class="sexp">(<a href="dffi.html#sizeof"><tt class="function">FFI:SIZEOF</tt></a> <i class="replaceable"><tt>c-place</tt></i>)</tt></dt><dd><p>The first form returns the size and alignment of the
   <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type <i class="replaceable"><tt>c-type</tt></i>, measured in bytes.</p><p>The second form returns the size and alignment of the
   <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type of <i class="replaceable"><tt>c-place</tt></i>, measured in bytes.
</p></dd><dt><a id="bitsizeof"></a><tt class="sexp">(<a href="dffi.html#bitsizeof"><tt class="function">FFI:BITSIZEOF</tt></a> <i class="replaceable"><tt>c-type</tt></i>)</tt><br /><tt class="sexp">(<a href="dffi.html#bitsizeof"><tt class="function">FFI:BITSIZEOF</tt></a> <i class="replaceable"><tt>c-place</tt></i>)</tt></dt><dd><p>The first form returns the size and alignment of the
   <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type <i class="replaceable"><tt>c-type</tt></i>, measured in bits.</p><p>The second form returns the size and alignment of the
   <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type of <i class="replaceable"><tt>c-place</tt></i>, measured in bits.
</p></dd><dt><a id="fa-null"></a><tt class="sexp">(<a href="dffi.html#fa-null"><tt class="function">FFI:FOREIGN-ADDRESS-NULL</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>)</tt></dt><dd>This predicate returns <a href="http://www.lisp.org/HyperSpec/Body/convar_t.html" target="_top"><tt class="constant">T</tt></a> if the
  <i class="replaceable"><tt>foreign-entity</tt></i> refers to the <tt class="constant">NULL</tt> address (and thus <i class="replaceable"><tt>foreign-entity</tt></i> should
  probably not be passed to most foreign functions).
</dd><dt><a id="faddr-u"></a><tt class="sexp">(<a href="dffi.html#faddr-u"><tt class="function">FFI:FOREIGN-ADDRESS-UNSIGNED</tt></a>
   <i class="replaceable"><tt>foreign-entity</tt></i>)</tt><br /><tt class="sexp">(<a href="dffi.html#faddr-u"><tt class="function">FFI:UNSIGNED-FOREIGN-ADDRESS</tt></a>
   <i class="replaceable"><tt>number</tt></i>)</tt></dt><dd><p><a href="dffi.html#faddr-u"><tt class="function">FFI:FOREIGN-ADDRESS-UNSIGNED</tt></a> returns the <a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a>
   address embodied in the Lisp object of type <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>,
   <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a>, <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> or <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><tt class="classname">FFI:FOREIGN-FUNCTION</tt></a>.</p><p><a href="dffi.html#faddr-u"><tt class="function">FFI:UNSIGNED-FOREIGN-ADDRESS</tt></a> returns a <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>
   object pointing to the given <a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a> address.
</p></dd><dt><a id="faddr"></a><tt class="sexp">(<a href="dffi.html#faddr"><tt class="function">FFI:FOREIGN-ADDRESS</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>)</tt></dt><dd><p><a href="dffi.html#faddr"><tt class="function">FFI:FOREIGN-ADDRESS</tt></a> is both a type name and a
   selector/constructor function. It is the Lisp object type
   corresponding to a <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a> external type declaration, e.g. a
   call-out function with <tt class="sexp">(<tt class="constant">:RETURN-TYPE</tt>
    <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a>)</tt> yields a Lisp object of type
   <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>.</p><p>The function extracts the object of type <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>
   living within any <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> or <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><tt class="classname">FFI:FOREIGN-FUNCTION</tt></a> object.
   If the <i class="replaceable"><tt>foreign-entity</tt></i> already is a <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>, it returns it.
   If it is a <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a> (e.g. a base foreign library address),
   it encapsulates it into a <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a> object, as suitable
   for use with a <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a> external type declaration.
   It does not construct addresses out of <a href="http://www.lisp.org/HyperSpec/Body/syscla_number.html" target="_top"><tt class="classname">NUMBER</tt></a>s,
   <a href="dffi.html#faddr-u"><tt class="function">FFI:UNSIGNED-FOREIGN-ADDRESS</tt></a> must be used for that purpose.
</p></dd><dt><a id="validp"></a><tt class="sexp">(<a href="dffi.html#validp"><tt class="function">FFI:VALIDP</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>)</tt><br /><tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a> (<a href="dffi.html#validp"><tt class="function">FFI:VALIDP</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>)
    <i class="replaceable"><tt>value</tt></i>)</tt></dt><dd><p>This predicate returns <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> if the <i class="replaceable"><tt>foreign-entity</tt></i>
  (e.g. the Lisp equivalent of a <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a>) refers to a pointer
  which is invalid because it comes from a previous Lisp session.
  It returns <a href="http://www.lisp.org/HyperSpec/Body/convar_t.html" target="_top"><tt class="constant">T</tt></a> if <i class="replaceable"><tt>foreign-entity</tt></i> can be used within the current Lisp process
  (thus it returns <a href="http://www.lisp.org/HyperSpec/Body/convar_t.html" target="_top"><tt class="constant">T</tt></a> for all non-foreign arguments).</p><p>You can invalidate a foreign object using
  <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a> <a href="dffi.html#validp"><tt class="function">FFI:VALIDP</tt></a>)</tt>.
  You cannot resurrect a zombie, nor can you kill a non-foreign
  object.</p></dd><dt><a id="fptr"></a><tt class="sexp">(<a href="dffi.html#fptr"><tt class="function">FFI:FOREIGN-POINTER</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>)</tt><br /><tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a> (<a href="dffi.html#fptr"><tt class="function">FFI:FOREIGN-POINTER</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>)
   <i class="replaceable"><tt>foreign-pointer</tt></i>)</tt></dt><dd><p><a href="dffi.html#fptr"><tt class="function">FFI:FOREIGN-POINTER</tt></a> returns the <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a>
   associated with the Lisp object of type <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>,
   <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a>, <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> or <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><tt class="classname">FFI:FOREIGN-FUNCTION</tt></a>.</p><p><tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a> <a href="dffi.html#fptr"><tt class="function">FFI:FOREIGN-POINTER</tt></a>)</tt>
   changes the <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a> associated with the Lisp object of
   type <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a>, <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> or <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><tt class="classname">FFI:FOREIGN-FUNCTION</tt></a> to
   that of the other entity.
   When <i class="replaceable"><tt>foreign-pointer</tt></i> is <tt class="constant">:COPY</tt>, a <a href="http://www.lisp.org/HyperSpec/Body/glo_f.html#fresh" target="_top">fresh</a> <a href="dffi.html#fptr"><tt class="classname">FFI:FOREIGN-POINTER</tt></a> is allocated.
   <i class="replaceable"><tt>foreign-entity</tt></i> still points to the same object. This is particularly useful
   with <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a> <a href="dffi.html#validp"><tt class="function">FFI:VALIDP</tt></a>)</tt>.
</p></dd><dt><a id="foreign-stack"></a><tt class="sexp">(<a href="dffi.html#foreign-stack"><tt class="function">FFI:WITH-FOREIGN-OBJECT</tt></a> (<i class="replaceable"><tt>variable</tt></i> <i class="replaceable"><tt>c-type</tt></i>
      [<i class="replaceable"><tt>initarg</tt></i>]) <i class="replaceable"><tt>body</tt></i>)</tt><br /><tt class="sexp">(<a href="dffi.html#foreign-stack"><tt class="function">FFI:WITH-C-VAR</tt></a> (<i class="replaceable"><tt>variable</tt></i> <i class="replaceable"><tt>c-type</tt></i>
      [<i class="replaceable"><tt>initarg</tt></i>]) <i class="replaceable"><tt>body</tt></i>)</tt></dt><dd><p>These forms allocate space on the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> execution
  stack, bind respectively a <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> object or
  a local <a href="http://www.lisp.org/HyperSpec/Body/mac_define-symbol-macro.html" target="_top"><tt class="classname">SYMBOL-MACRO</tt></a> to <i class="replaceable"><tt>variable</tt></i> and execute <i class="replaceable"><tt>body</tt></i>.</p><p>When <i class="replaceable"><tt>initarg</tt></i> is not supplied,
  they allocate space only for <tt class="sexp">(<a href="dffi.html#sizeof"><tt class="function">FFI:SIZEOF</tt></a>
  <i class="replaceable"><tt>c-type</tt></i>)</tt> bytes.  This space is filled with zeroes.  E.g.,
  using a <i class="replaceable"><tt>c-type</tt></i> of <a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a> or even <tt class="type">(<a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a>
  (<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a> <span class="type">uint8</span> 32))</tt> (!) both allocate place
  for a single pointer, initialized to <tt class="constant">NULL</tt>.</p><p>When <i class="replaceable"><tt>initarg</tt></i> is supplied, they
  allocate space for an arbitrarily complex set of structures rooted in
  <i class="replaceable"><tt>c-type</tt></i>.  Therefore, <a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a>, <tt class="sexp">#()</tt>
  and <tt class="sexp">""</tt> are your friends for creating a
  pointer to the empty arrays:
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">(with-c-var (v '(c-ptr (c-array-max uint8 32)) #())
  (setf (element (deref v) 0) 127) v)</pre></td></tr></table><p>
  <i class="replaceable"><tt>c-type</tt></i> is evaluated, making creation of variable sized buffers easy:
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">(with-c-var (fv `(c-array uint8 ,(length my-vector)) my-vector)
  (print fv))</pre></td></tr></table><p>
 </p></dd><dt><a id="foreign-stack-string"></a><tt class="sexp">(<a href="dffi.html#foreign-stack-string"><tt class="function">FFI:WITH-FOREIGN-STRING</tt></a>
   (<i class="replaceable"><tt>foreign-address</tt></i> <i class="replaceable"><tt>char-count</tt></i>
    <i class="replaceable"><tt>byte-count</tt></i> <i class="replaceable"><tt>string</tt></i>
    <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><tt class="literal">&amp;KEY</tt></a> <i class="replaceable"><tt>encoding</tt></i> <i class="replaceable"><tt>null-terminated-p</tt></i>
    <i class="replaceable"><tt>start</tt></i> <i class="replaceable"><tt>end</tt></i>) <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-4.html" target="_top"><tt class="literal">&amp;BODY</tt></a> <i class="replaceable"><tt>body</tt></i>)</tt></dt><dd><p>This forms converts a Lisp <i class="replaceable"><tt>string</tt></i> according to
   the <i class="replaceable"><tt>encoding</tt></i>, allocating space on the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> execution stack.
   <i class="replaceable"><tt>encoding</tt></i> can be any <a href="encoding.html" title="29.4. Extensions-1.4. Encodings"><tt class="classname">EXT:ENCODING</tt></a>, e.g.
   <a href="encoding.html#charset-UTF-16"><tt class="constant">CHARSET:UTF-16</tt></a>
   or <a href="encoding.html#charset-UTF-8"><tt class="constant">CHARSET:UTF-8</tt></a>, circumventing the usual 1:1 limit imposed on
   <a href="encoding.html#foreign-enc"><tt class="varname">CUSTOM:*FOREIGN-ENCODING*</tt></a>.</p><p><i class="replaceable"><tt>body</tt></i> is then executed with the three variables <i class="replaceable"><tt>foreign-address</tt></i>,
   <i class="replaceable"><tt>char-count</tt></i> and
   <i class="replaceable"><tt>byte-count</tt></i> respectively bound to an
   untyped <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a> (as known from the <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a> foreign
   type specification) pointing to the stack location, the number of
   <a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a>s of the Lisp <i class="replaceable"><tt>string</tt></i> that were considered and the
   number of <tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8)</tt> bytes that were allocated for it on the
   <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> stack.</p><p>When <i class="replaceable"><tt>null-terminated-p</tt></i> is true,
   which is the default, a variable number of zero bytes is appended,
   depending on the encoding, e.g. 2 for <a href="encoding.html#charset-UTF-8"><tt class="constant">CHARSET:UTF-8</tt></a>,
   and accounted for in <i class="replaceable"><tt>byte-count</tt></i>,
   and <i class="replaceable"><tt>char-count</tt></i> is incremented by one.</p><p>The <a href="dffi.html#faddr"><tt class="classname">FFI:FOREIGN-ADDRESS</tt></a> object bound to <i class="replaceable"><tt>foreign-address</tt></i> is
   invalidated upon the exit from the form.</p><p>A stupid example (a quite costly interface to <a href="http://www.opengroup.org/onlinepubs/007904975/functions/mblen.html" target="_top"><tt class="function">mblen</tt></a>):
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">(with-foreign-string (fv elems bytes string
                      :encoding charset:jis... :null-terminated-p nil
                      :end 5)
 (declare (ignore fv elems))
 (format t "This string would take ~D bytes." bytes))</pre></td></tr></table><p>
</p></dd><dt><a id="c-type-parse"></a><tt class="sexp">(<a href="dffi.html#c-type-parse"><tt class="function">FFI:PARSE-C-TYPE</tt></a> <i class="replaceable"><tt>c-type</tt></i>)</tt><br /><tt class="sexp">(<a href="dffi.html#c-type-parse"><tt class="function">FFI:DEPARSE-C-TYPE</tt></a> <i class="replaceable"><tt>c-type-internal</tt></i>)</tt></dt><dd>Convert between the external (<a href="http://www.lisp.org/HyperSpec/Body/syscla_list.html" target="_top"><tt class="classname">LIST</tt></a>) and internal
   (<a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a>) <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type representations (used by <a href="http://www.lisp.org/HyperSpec/Body/fun_describe.html" target="_top"><tt class="function">DESCRIBE</tt></a>).
</dd><dt><a id="foreign-heap"></a><tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-SHALLOW</tt></a> <i class="replaceable"><tt>c-type</tt></i>
   <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><tt class="literal">&amp;KEY</tt></a> <tt class="constant">:COUNT</tt> <tt class="constant">:READ-ONLY</tt>)</tt><br /><tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-DEEP</tt></a> <i class="replaceable"><tt>c-type</tt></i> <i class="replaceable"><tt>contents</tt></i>
   <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><tt class="literal">&amp;KEY</tt></a> <tt class="constant">:COUNT</tt> <tt class="constant">:READ-ONLY</tt>)</tt><br /><tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:FOREIGN-FREE</tt></a> <i class="replaceable"><tt>foreign-entity</tt></i>
   <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><tt class="literal">&amp;KEY</tt></a> :FULL)</tt><br /><tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:FOREIGN-ALLOCATE</tt></a> <i class="replaceable"><tt>c-type-internal</tt></i>
   <a href="http://www.lisp.org/HyperSpec/Body/sec_3-4-1.html" target="_top"><tt class="literal">&amp;KEY</tt></a> :INITIAL-CONTENTS <tt class="constant">:COUNT</tt> <tt class="constant">:READ-ONLY</tt>)</tt></dt><dd><p>Macro <a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-SHALLOW</tt></a> allocates
   <tt class="sexp">(<a href="dffi.html#sizeof"><tt class="function">FFI:SIZEOF</tt></a> <i class="replaceable"><tt>c-type</tt></i>)</tt>
   bytes on the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> heap and zeroes them out (like <a href="http://www.opengroup.org/onlinepubs/007904975/functions/calloc.html" target="_top"><tt class="function">calloc</tt></a>).
   When <tt class="constant">:COUNT</tt> is supplied, <i class="replaceable"><tt>c-type</tt></i> is substituted with
   <tt class="type">(<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a> <i class="replaceable"><tt>c-type</tt></i> <i class="replaceable"><tt>count</tt></i>)</tt>,
   except when <i class="replaceable"><tt>c-type</tt></i> is <a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a>, in which case
   <tt class="type">(<a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a> <a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a> <i class="replaceable"><tt>count</tt></i>)</tt>
   is used instead.
   When <tt class="constant">:READ-ONLY</tt> is supplied, the Lisp side is prevented from modifying the
   memory contents.  This can be used as an indication that some foreign
   side is going to fill this memory (e.g. via <a href="http://www.opengroup.org/onlinepubs/007904975/functions/read.html" target="_top"><tt class="function">read</tt></a>).</p><p>Returns a <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> object of the actual <i class="replaceable"><tt>c-type</tt></i>,
   whose address part points to the newly allocated memory.</p><p><a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-DEEP</tt></a> will call <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> <a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a> as many times
   as necessary to build a structure on the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> heap of the given
   <i class="replaceable"><tt>c-type</tt></i>, initialized from the given <i class="replaceable"><tt>contents</tt></i>.</p><p>E.g., <tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-DEEP</tt></a> '<a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a>
    "ABCDE")</tt> performs 2 allocations: one for a <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>
   pointer to a string, another for the contents of that string.
   This would be useful in conjunction with a <span class="type">char**</span>
   <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type declaration.  <tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-SHALLOW</tt></a>
    '<a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a>)</tt> allocates room for a single pointer
   (probably 4 bytes).</p><p><tt class="sexp">(<a href="dffi.html#foreign-heap"><tt class="function">FFI:ALLOCATE-DEEP</tt></a> '<a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a>
    "ABCDEF" :count 10)</tt> allocates and initializes room for the
   type <tt class="type">(<a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a> <a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a> 10)</tt>,
   corresponding to <span class="type">char*</span> or, more specifically,
   <span class="type">char[10]</span> in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>.</p><p>Function <a href="dffi.html#foreign-heap"><tt class="function">FFI:FOREIGN-FREE</tt></a> deallocates memory at the address
   held by the given <i class="replaceable"><tt>foreign-entity</tt></i>. If <tt class="constant">:FULL</tt> is supplied
   and the argument is of type <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a>, recursively frees
   the whole complex stucture pointed to by this variable.</p><p>If given a <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><tt class="classname">FFI:FOREIGN-FUNCTION</tt></a> object that corresponds to a
   <a href="http://clisp.cons.org" target="_top"><span><b class="command">CLISP</b></span></a> callback, deallocates it.  Callbacks are automatically
   created each time you pass a Lisp function via the <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a>.</p><p>Use <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a> <a href="dffi.html#validp"><tt class="function">FFI:VALIDP</tt></a>)</tt> to
   disable further references to this address from Lisp.
   This is currently not done automatically.
   If the given pointer is already invalid, <a href="dffi.html#foreign-heap"><tt class="function">FFI:FOREIGN-FREE</tt></a> (currently)
   signals an <a href="http://www.lisp.org/HyperSpec/Body/contyp_error.html" target="_top"><tt class="classname">ERROR</tt></a>. This may change to make it easier to integrate
   with <a href="final.html" title="29.7. Extensions-1.7. Finalization"><tt class="function">EXT:FINALIZE</tt></a>.</p><p>Function <a href="dffi.html#foreign-heap"><tt class="function">FFI:FOREIGN-ALLOCATE</tt></a> is a lower-level interface as it
   requires an internal <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type descriptor as returned by
   <a href="dffi.html#c-type-parse"><tt class="function">FFI:PARSE-C-TYPE</tt></a>.</p></dd><dt><a id="with-c-place"></a><tt class="sexp">(<a href="dffi.html#with-c-place"><tt class="function">FFI:WITH-C-PLACE</tt></a> (<i class="replaceable"><tt>variable</tt></i> <i class="replaceable"><tt>foreign-entity</tt></i>)
   <i class="replaceable"><tt>body</tt></i>)</tt></dt><dd><p>Create a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> out of the given <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a>
  object so operations on places (e.g. <a href="dffi.html#cast"><tt class="function">FFI:CAST</tt></a>, <a href="dffi.html#deref"><tt class="function">FFI:DEREF</tt></a>, <a href="dffi.html#slot"><tt class="function">FFI:SLOT</tt></a> etc.) can
  be used within <i class="replaceable"><tt>body</tt></i>.  <a href="dffi.html#foreign-stack"><tt class="function">FFI:WITH-C-VAR</tt></a> appears as a composition of
  <a href="dffi.html#foreign-stack"><tt class="function">FFI:WITH-FOREIGN-OBJECT</tt></a> and <a href="dffi.html#with-c-place"><tt class="function">FFI:WITH-C-PLACE</tt></a>.</p><p>Such a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a> can be used to access memory referenced by a <i class="replaceable"><tt>foreign-entity</tt></i>
  object:
  </p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">(setq foo (allocate-deep '(c-array uint8 3) rgb))
(with-c-place (place foo) (element place 0))</pre></td></tr></table><p>
</p></dd><dt><a id="ffi-extern-output"></a><a href="dffi.html#ffi-extern-output"><tt class="varname">FFI:*OUTPUT-C-FUNCTIONS*</tt></a><br /><tt class="varname">FFI:*OUTPUT-C-VARIABLES*</tt></dt><dd><a href="http://clisp.cons.org" target="_top"><span><b class="command">CLISP</b></span></a> will write the <span class="type">extern</span>
   declarations for foreign functions (defined with <a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a>) and
   foreign variables (defined with <a href="dffi.html#def-c-var"><tt class="function">FFI:DEF-C-VAR</tt></a>) into the output <tt class="filename">#P".c"</tt>
   (when the Lisp file is compiled with <a href="http://www.lisp.org/HyperSpec/Body/fun_compile-file.html" target="_top"><tt class="function">COMPILE-FILE</tt></a>)
   <span class="emphasis"><em>unless</em></span> these variables are <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>.
   They are <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> by default, so the <span class="type">extern</span>
   declarations are <span class="emphasis"><em>not</em></span> written; you are encouraged to use
   <a href="dffi.html#c-lines"><tt class="function">FFI:C-LINES</tt></a> to include the appropriate <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> headers.
   Set these variables to non-<a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> if the headers are not available or
   not usable.</dd></dl></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="dffi-types"></a>30.3.2. (Foreign) <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types</h3></div></div><div></div></div><p>Foreign <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types are used in the <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a>.
They are <span class="emphasis"><em>not</em></span> regular <a href="http://www.lisp.org" target="_top"><span><b class="command">Common Lisp</b></span></a> types or <span><b class="command">CLOS</b></span> classes.</p><p>A <i class="replaceable"><tt>c-type</tt></i> is either a predefined <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> type or the name of a
 type defined by <a href="dffi.html#def-c-type"><tt class="function">FFI:DEF-C-TYPE</tt></a>.</p><div class="variablelist"><p class="title"><b>the predefined <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types (<i class="replaceable"><tt>c-type</tt></i>)</b></p><dl><dt><a id="simple-c-type"></a><i class="replaceable"><tt>simple-c-type</tt></i></dt><dd><p>the simple <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> types
  </p><div class="informaltable"><a id="simple-c-type-tab"></a><table border="1"><colgroup><col /><col /><col /><col /><col /></colgroup><thead><tr><th align="center">Lisp name</th><th align="center">Lisp equivalent</th><th align="center"><a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> equivalent</th><th align="center">ILU
 equivalent</th><th align="center">Comment</th></tr></thead><tbody><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a></td><td align="center"><span class="type">void</span></td><td align="center"> </td><td align="center">as a result type only</td></tr><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_boolean.html" target="_top"><tt class="classname">BOOLEAN</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_boolean.html" target="_top"><tt class="classname">BOOLEAN</tt></a></td><td align="center"><span class="type">int</span></td><td align="center"><span class="type">BOOLEAN</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a></td><td align="center"><span class="type">char</span></td><td align="center"><span class="type">SHORT CHARACTER</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">char</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">signed char</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">uchar</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">unsigned char</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">short</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">short</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">ushort</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">unsigned short</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">int</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">int</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">uint</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">unsigned int</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">long</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">long</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">ulong</span></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/syscla_integer.html" target="_top"><tt class="classname">INTEGER</tt></a></td><td align="center"><span class="type">unsigned long</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">uint8</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 8)</tt></td><td align="center"><span class="type">uint8</span></td><td align="center"><span class="type">BYTE</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">sint8</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 8)</tt></td><td align="center"><span class="type">sint8</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">uint16</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 16)</tt></td><td align="center"><span class="type">uint16</span></td><td align="center"><span class="type">SHORT CARDINAL</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">sint16</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 16)</tt></td><td align="center"><span class="type">sint16</span></td><td align="center"><span class="type">SHORT INTEGER</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">uint32</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 32)</tt></td><td align="center"><span class="type">uint32</span></td><td align="center"><span class="type">CARDINAL</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">sint32</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 32)</tt></td><td align="center"><span class="type">sint32</span></td><td align="center"><span class="type">INTEGER</span></td><td class="auto-generated"> </td></tr><tr><td align="center"><span class="type">uint64</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_unsigned-byte.html" target="_top"><tt class="classname">UNSIGNED-BYTE</tt></a> 64)</tt></td><td align="center"><span class="type">uint64</span></td><td align="center"><span class="type">LONG CARDINAL</span></td><td align="center">does not work on all platforms</td></tr><tr><td align="center"><span class="type">sint64</span></td><td align="center"><tt class="type">(<a href="http://www.lisp.org/HyperSpec/Body/typ_signed-byte.html" target="_top"><tt class="classname">SIGNED-BYTE</tt></a> 64)</tt></td><td align="center"><span class="type">sint64</span></td><td align="center"><span class="type">LONG INTEGER</span></td><td align="center">does not work on all platforms</td></tr><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_short-flo_m_long-float.html" target="_top"><tt class="classname">SINGLE-FLOAT</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_short-flo_m_long-float.html" target="_top"><tt class="classname">SINGLE-FLOAT</tt></a></td><td align="center"><span class="type">float</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr><tr><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_short-flo_m_long-float.html" target="_top"><tt class="classname">DOUBLE-FLOAT</tt></a></td><td align="center"><a href="http://www.lisp.org/HyperSpec/Body/typ_short-flo_m_long-float.html" target="_top"><tt class="classname">DOUBLE-FLOAT</tt></a></td><td align="center"><span class="type">double</span></td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr></tbody></table></div></dd><dt><a id="c-pointer"></a><a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a></dt><dd>This type corresponds to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
   <span class="type">void*</span>, an opaque pointer.
   When used as an argument, <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> is accepted as a <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a> and
   treated as <tt class="constant">NULL</tt>; when a function wants to return a <tt class="constant">NULL</tt>
   <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a>, it actually returns <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>.
</dd><dt><a id="c-string"></a><a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a></dt><dd>This type corresponds to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type">char*</span>, a zero-terminated string.  Its Lisp equivalent is
  a string, without the trailing zero character.
 </dd><dt><a id="c-struct"></a><tt class="type">(<a href="dffi.html#c-struct"><span class="type">FFI:C-STRUCT</span></a>
  <i class="replaceable"><tt>class</tt></i> (<i class="replaceable"><tt>ident<sub>1</sub></tt></i>
   <i class="replaceable"><tt>c-type<sub>1</sub></tt></i>) ...
  (<i class="replaceable"><tt>ident<sub>n</sub></tt></i>
   <i class="replaceable"><tt>c-type<sub>n</sub></tt></i>))</tt></dt><dd><p>This type is equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
 <span class="type">struct { <i class="replaceable"><tt>c-type<sub>1</sub></tt></i>
 <i class="replaceable"><tt>ident<sub>1</sub></tt></i>; ...;
 <i class="replaceable"><tt>c-type<sub>n</sub></tt></i>
 <i class="replaceable"><tt>ident<sub>n</sub></tt></i>; }</span>.
 Its Lisp equivalent is: if <i class="replaceable"><tt>class</tt></i> is <a href="http://www.lisp.org/HyperSpec/Body/syscla_vector.html" target="_top"><tt class="classname">VECTOR</tt></a>, a
 <a href="http://www.lisp.org/HyperSpec/Body/typ_simple-vector.html" target="_top"><tt class="classname">SIMPLE-VECTOR</tt></a>; if <i class="replaceable"><tt>class</tt></i> is <a href="http://www.lisp.org/HyperSpec/Body/syscla_list.html" target="_top"><tt class="classname">LIST</tt></a>, a
 <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#proper_list" target="_top">proper list</a>;
 if <i class="replaceable"><tt>class</tt></i> is a symbol naming a structure or <span><b class="command">CLOS</b></span> class, an
 instance of this class, with slots of names
 <i class="replaceable"><tt>ident<sub>1</sub></tt></i>, ...,
 <i class="replaceable"><tt>ident<sub>n</sub></tt></i>.</p><p>
 <i class="replaceable"><tt>class</tt></i> may also be a <a href="http://www.lisp.org/HyperSpec/Body/syscla_cons.html" target="_top"><tt class="classname">CONS</tt></a> of a <a href="http://www.lisp.org/HyperSpec/Body/syscla_symbol.html" target="_top"><tt class="classname">SYMBOL</tt></a> (as above) and
 a <a href="http://www.lisp.org/HyperSpec/Body/syscla_list.html" target="_top"><tt class="classname">LIST</tt></a> of <a href="dffi.html#def-c-struct"><tt class="function">FFI:DEF-C-STRUCT</tt></a> options.
 </p></dd><dt><a id="c-union"></a><tt class="type">(<a href="dffi.html#c-union"><span class="type">FFI:C-UNION</span></a>
  (<i class="replaceable"><tt>ident<sub>1</sub></tt></i>
   <i class="replaceable"><tt>c-type<sub>1</sub></tt></i>) ...
  (<i class="replaceable"><tt>ident<sub>n</sub></tt></i>
   <i class="replaceable"><tt>c-type<sub>n</sub></tt></i>))</tt></dt><dd>This type is equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type">union { <i class="replaceable"><tt>c-type<sub>1</sub></tt></i>
  <i class="replaceable"><tt>ident<sub>1</sub></tt></i>; ...;
  <i class="replaceable"><tt>c-type<sub>n</sub></tt></i>
  <i class="replaceable"><tt>ident<sub>n</sub></tt></i>;
  }</span>.
  Conversion to and from Lisp assumes that a value is to be viewed as
  being of <i class="replaceable"><tt>c-type<sub>1</sub></tt></i>.
 </dd><dt><a id="c-array"></a><tt class="type">(<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a>
   <i class="replaceable"><tt>c-type</tt></i> <i class="replaceable"><tt>dim<sub>1</sub></tt></i>)</tt><br /><tt class="type">(<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a>
   <i class="replaceable"><tt>c-type</tt></i> (<i class="replaceable"><tt>dim<sub>1</sub></tt></i> ...
   <i class="replaceable"><tt>dim<sub>n</sub></tt></i>))</tt></dt><dd>This type is equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type"><i class="replaceable"><tt>c-type</tt></i> [<i class="replaceable"><tt>dim<sub>1</sub></tt></i>]
  ... [<i class="replaceable"><tt>dim<sub>n</sub></tt></i>]</span>.
  Note that when an array is passed as an argument to a function in
  <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>, it is actually passed as a pointer; you therefore have to
  write <tt class="type">(<a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a> (<a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a> ...))</tt> for this
  argument's type.</dd><dt><a id="c-array-max"></a><tt class="type">(<a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a>
  <i class="replaceable"><tt>c-type</tt></i> <i class="replaceable"><tt>maxdimension</tt></i>)</tt></dt><dd>This type is equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type"><i class="replaceable"><tt>c-type</tt></i> [<i class="replaceable"><tt>maxdimension</tt></i>]</span>, an array containing up to
  <i class="replaceable"><tt>maxdimension</tt></i> elements.
  The array is zero-terminated if it contains less than <i class="replaceable"><tt>maxdimension</tt></i> elements.
  Conversion from Lisp of an array with more than <i class="replaceable"><tt>maxdimension</tt></i> elements
  silently ignores the superfluous elements.
  </dd><dt><a id="c-function"></a><tt class="type">(<a href="dffi.html#c-function"><span class="type">FFI:C-FUNCTION</span></a> (<tt class="constant">:ARGUMENTS</tt>
      {(<i class="replaceable"><tt>argument</tt></i> <i class="replaceable"><tt>a-c-type</tt></i>
        [<a href="dffi.html#param-mode" title="30.3.8. Parameter Mode"><i class="replaceable"><tt>PARAM-MODE</tt></i></a> [<a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>]])}*)
    (<tt class="constant">:RETURN-TYPE</tt> <i class="replaceable"><tt>r-c-type</tt></i> [<a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a>])
    (<a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor."><tt class="constant">:LANGUAGE</tt></a> <i class="replaceable"><tt>language</tt></i>))</tt></dt><dd>This type designates a <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function that can be
  called according to the given prototype <tt class="sexp">(<i class="replaceable"><tt>r-c-type</tt></i> (*)
  (<i class="replaceable"><tt>a-c-type<sub>1</sub></tt></i>, ...))</tt>.
  Conversion between <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> functions and Lisp functions
  is transparent, and <tt class="constant">NULL</tt>/<a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a> is recognized and
  accepted.</dd><dt><a id="c-ptr"></a><tt class="type">(<a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a>
              <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>This type is equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type"><i class="replaceable"><tt>c-type</tt></i> *</span>: a pointer to a single item of the given
  <i class="replaceable"><tt>c-type</tt></i>.</dd><dt><a id="c-ptr-null"></a><tt class="type">(<a href="dffi.html#c-ptr-null"><span class="type">FFI:C-PTR-NULL</span></a> <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>This type is also equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type"><i class="replaceable"><tt>c-type</tt></i> *</span>: a pointer to a single item of the given
  <i class="replaceable"><tt>c-type</tt></i>, with the exception that <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> <tt class="constant">NULL</tt> corresponds to
  Lisp <a href="http://www.lisp.org/HyperSpec/Body/convar_nil.html" target="_top"><tt class="constant">NIL</tt></a>.</dd><dt><a id="c-array-ptr"></a><tt class="type">(<a href="dffi.html#c-array-ptr"><span class="type">FFI:C-ARRAY-PTR</span></a> <i class="replaceable"><tt>c-type</tt></i>)</tt></dt><dd>This type is equivalent to what <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> calls
  <span class="type"><i class="replaceable"><tt>c-type</tt></i> (*)[]</span>: a pointer to a zero-terminated array of
  items of the given <i class="replaceable"><tt>c-type</tt></i>.</dd></dl></div>
<!--#ifdef UNICODE--><p><a href="encoding.html#foreign-enc"><tt class="varname">CUSTOM:*FOREIGN-ENCODING*</tt></a> governs conversion for any <i class="replaceable"><tt>c-type</tt></i> involving
 <a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a> or <a href="http://www.lisp.org/HyperSpec/Body/syscla_character.html" target="_top"><tt class="classname">CHARACTER</tt></a> (but not <span class="type">char</span>).</p>
<!--#endif-->
</div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="c-flavor"></a>30.3.3. The choice of the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> flavor.</h3></div></div><div></div></div><p><a href="dffi.html#c-function"><span class="type">FFI:C-FUNCTION</span></a>, <a href="dffi.html#def-call-in"><tt class="function">FFI:DEF-CALL-IN</tt></a>, <a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a> take <a href="dffi.html#c-flavor" title="30.3.3. The choice of the C flavor."><tt class="constant">:LANGUAGE</tt></a> argument.
The <i class="replaceable"><tt>language</tt></i> is either <tt class="constant">:C</tt> (denotes K&amp;R <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>) or <tt class="constant">:STDC</tt>
(denotes ANSI <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>) or <tt class="constant">:STDC-STDCALL</tt> (denotes ANSI <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>
with the <span class="emphasis"><em>stdcall</em></span> calling convention).
It specifies whether the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function (caller or callee) has been
compiled by a K&amp;R <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> compiler or by an ANSI <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> compiler,
and possibly the calling convention.</p><p>The default language is set using the macro
 <tt class="function">FFI:DEFAULT-FOREIGN-LANGUAGE</tt>.
If this macro has not been called in the current
 <a href="http://www.lisp.org/HyperSpec/Body/glo_c.html#compilation_unit" target="_top">compilation
unit</a> (usually a file), a warning is issued and
<tt class="constant">:STDC</tt> is used for the rest of the unit.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="dffi-variables"></a>30.3.4. Foreign variables</h3></div></div><div></div></div><p>Foreign variables are variables whose storage is allocated in the
 foreign language module.  They can nevertheless be evaluated and
 modified through <a href="http://www.lisp.org/HyperSpec/Body/spefor_setq.html" target="_top"><tt class="function">SETQ</tt></a>, just as normal variables can, except that the
 range of allowed values is limited according to the variable's foreign
 type.  Note that for a foreign variable <i class="replaceable"><tt>x</tt></i> the form <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/fun_eql.html" target="_top"><tt class="function">EQL</tt></a> <i class="replaceable"><tt>x</tt></i> <i class="replaceable"><tt>x</tt></i>)</tt> is not necessarily true,
 since every time <i class="replaceable"><tt>x</tt></i> is evaluated its foreign value is converted to a
 <a href="http://www.lisp.org/HyperSpec/Body/glo_f.html#fresh" target="_top">fresh</a> Lisp value.  Foreign variables are defined using
 <a href="dffi.html#def-c-var"><tt class="function">FFI:DEF-C-VAR</tt></a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="dffi-places"></a>30.3.5. Operations on foreign places</h3></div></div><div></div></div><p>A <a href="dffi.html#dffi-variables" title="30.3.4. Foreign variables"><tt class="classname">FFI:FOREIGN-VARIABLE</tt></a> <i class="replaceable"><tt>name</tt></i> defined by <a href="dffi.html#def-c-var"><tt class="function">FFI:DEF-C-VAR</tt></a>, <a href="dffi.html#foreign-stack"><tt class="function">FFI:WITH-C-VAR</tt></a>
 or <a href="dffi.html#with-c-place"><tt class="function">FFI:WITH-C-PLACE</tt></a> defines a <a href="http://www.lisp.org/HyperSpec/Body/glo_p.html#place" target="_top">place</a>,
 i.e., a form which can also be used as argument to <a href="http://www.lisp.org/HyperSpec/Body/mac_setfcm_psetf.html" target="_top"><tt class="function">SETF</tt></a>.
 (An "lvalue" in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> terminology.)
 The following operations are available on foreign places:
 <a href="dffi.html#element"><tt class="function">FFI:ELEMENT</tt></a>, <a href="dffi.html#deref"><tt class="function">FFI:DEREF</tt></a>, <a href="dffi.html#slot"><tt class="function">FFI:SLOT</tt></a>, <a href="dffi.html#cast"><tt class="function">FFI:CAST</tt></a>, <a href="dffi.html#offset"><tt class="function">FFI:OFFSET</tt></a>, <a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a>,
 <a href="dffi.html#c-var-object"><tt class="function">FFI:C-VAR-OBJECT</tt></a>, <a href="dffi.html#typeof"><tt class="function">FFI:TYPEOF</tt></a>, <a href="dffi.html#sizeof"><tt class="function">FFI:SIZEOF</tt></a>, <a href="dffi.html#bitsizeof"><tt class="function">FFI:BITSIZEOF</tt></a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="dffi-functions"></a>30.3.6. Foreign functions</h3></div></div><div></div></div><p>Foreign functions are functions which are defined in the foreign
 language.  There are <span class="emphasis"><em>named foreign functions</em></span>
 (imported via <a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a> or created via <a href="dffi.html#def-call-in"><tt class="function">FFI:DEF-CALL-IN</tt></a>) and
 <span class="emphasis"><em>anonymous foreign functions</em></span>; they arise through
 conversion of function pointers.</p><p>A <span class="emphasis"><em>"call-out"</em></span> function is a foreign function
 called from Lisp: control flow temporarily leaves Lisp.  A
 <span class="emphasis"><em>"call-in"</em></span> function is a Lisp function called from
 the foreign language: control flow temporary enters Lisp.</p><p>The following forms define foreign functions: <a href="dffi.html#def-call-in"><tt class="function">FFI:DEF-CALL-IN</tt></a>,
 <a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a>, <a href="dffi.html#def-c-call-in"><tt class="function">FFI:DEF-C-CALL-IN</tt></a>, <a href="dffi.html#def-c-call-out"><tt class="function">FFI:DEF-C-CALL-OUT</tt></a>.</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="allocation"></a>30.3.7. Argument and result passing conventions</h3></div></div><div></div></div><p>When passed to and from functions, allocation of arguments and
 results is handled as follows:</p><p>Values of <a href="dffi.html#simple-c-type"><i class="replaceable"><tt>SIMPLE-C-TYPE</tt></i></a>, <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a> are passed on the stack,
 with dynamic extent. The <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is effectively ignored.</p><p>Values of type <a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a>, <a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a>, <a href="dffi.html#c-ptr-null"><span class="type">FFI:C-PTR-NULL</span></a>, <a href="dffi.html#c-array-ptr"><span class="type">FFI:C-ARRAY-PTR</span></a>
 need storage.  The <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> specifies the allocation policy:
</p><div class="variablelist"><dl><dt><tt class="constant">:NONE</tt></dt><dd>no storage is allocated.
</dd><dt><tt class="constant">:ALLOCA</tt></dt><dd>allocation of storage on the stack, which has
   dynamic extent.</dd><dt><tt class="constant">:MALLOC-FREE</tt></dt><dd>storage will be allocated via <a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a> and freed via
   <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a>.</dd></dl></div><p>If no <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is specified, the default <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is
 <tt class="constant">:NONE</tt> for most types, but <tt class="constant">:ALLOCA</tt> for <a href="dffi.html#c-string"><span class="type">FFI:C-STRING</span></a> and <a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a> and
 <a href="dffi.html#c-ptr-null"><span class="type">FFI:C-PTR-NULL</span></a> and <a href="dffi.html#c-array-ptr"><span class="type">FFI:C-ARRAY-PTR</span></a> and for <tt class="constant">:OUT</tt> arguments. [Subject to
 change!]  The <tt class="constant">:MALLOC-FREE</tt> policy provides the ability to pass
 arbitrarily nested structs containing pointers pointing to structs
 ... within a single conversion.</p><div class="variablelist"><dl><dt>For call-out functions:</dt><dd><div class="variablelist"><dl><dt>For arguments passed from Lisp to <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>:</dt><dd><div class="variablelist"><dl><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:MALLOC-FREE</tt>:</dt><dd>Lisp allocates the storage using <a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a> and
     never deallocates it.  The <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function is supposed to call
     <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a> when done with it.</dd><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:ALLOCA</tt>:</dt><dd>Lisp allocates the storage on the stack, with
     dynamic extent.  It is freed when the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function returns.
    </dd><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:NONE</tt>:</dt><dd>Lisp assumes that the pointer already points to a
     valid area of the proper size and puts the result value there.
     This is dangerous! and deprecated.
    </dd></dl></div></dd><dt>For results passed from <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> to Lisp:</dt><dd><div class="variablelist"><dl><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:MALLOC-FREE</tt>:</dt><dd>Lisp calls <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a> on it when done.
    </dd><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:NONE</tt>:</dt><dd>Lisp does nothing.
    </dd></dl></div></dd></dl></div></dd><dt>For call-in functions:</dt><dd><div class="variablelist"><dl><dt>For arguments passed from <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> to Lisp:</dt><dd><div class="variablelist"><dl><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:MALLOC-FREE</tt>:</dt><dd>Lisp calls <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a> on it when done.
     </dd><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:ALLOCA</tt> or <tt class="constant">:NONE</tt>:</dt><dd>Lisp does nothing.
     </dd></dl></div></dd><dt>For results passed from Lisp to <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>:</dt><dd><div class="variablelist"><dl><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:MALLOC-FREE</tt>:</dt><dd>Lisp allocates the storage using <a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a> and
      never deallocates it.  The <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> function is supposed to call
      <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a> when done with it.</dd><dt>If <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> is <tt class="constant">:NONE</tt>:</dt><dd>Lisp assumes that the pointer already points to a
     valid area of the proper size and puts the result value there.
     This is dangerous! and deprecated.
    </dd></dl></div></dd></dl></div></dd></dl></div><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title"><a id="ffi-struct-arg"></a>Warning</h3><p>Passing <a href="dffi.html#c-struct"><span class="type">FFI:C-STRUCT</span></a>, <a href="dffi.html#c-union"><span class="type">FFI:C-UNION</span></a>,
  <a href="dffi.html#c-array"><span class="type">FFI:C-ARRAY</span></a>, <a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a> values as arguments (not via pointers) is
  only possible to the extent the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> compiler supports it.
  Most <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> compilers do it right, but some <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> compilers
  (such as <a href="http://gcc.gnu.org/" target="_top"><span><b class="command">gcc</b></span></a> on hppa and <a href="http://www.willows.com/" target="_top"><strong>Win32</strong></a>) have problems with this.
  The recommended workaround is to pass pointers; this is fully supported.
  See also this <tt class="email">&lt;<a href="mailto:clisp-list@sf.net">clisp-list@sf.net</a>&gt;</tt>
  <a href="http://article.gmane.org/gmane.lisp.clisp.devel/10089" target="_top">message</a>.</p></div></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="param-mode"></a>30.3.8. Parameter Mode</h3></div></div><div></div></div><p>A function parameter's <a href="dffi.html#param-mode" title="30.3.8. Parameter Mode"><i class="replaceable"><tt>PARAM-MODE</tt></i></a> may be</p><div class="variablelist"><dl><dt><tt class="constant">:IN</tt> (means: read-only):</dt><dd>The caller passes information to the callee.
  </dd><dt><tt class="constant">:OUT</tt> (means: write-only):</dt><dd>The callee passes information back to the caller on
   return.  When viewed as a Lisp function, there is no Lisp argument
   corresponding to this, instead it means an additional return value.
  </dd><dt><tt class="constant">:IN-OUT</tt> (means: read-write):</dt><dd>Information is passed from the caller to the callee
   and then back to the caller.  When viewed as a Lisp function, the
   <tt class="constant">:OUT</tt> value is returned as an additional multiple value.
  </dd></dl></div><p>The default is <tt class="constant">:IN</tt>.</p><p>[Currently, only <tt class="constant">:IN</tt> is fully implemented.  <tt class="constant">:OUT</tt> works only
 with <a href="dffi.html#allocation" title="30.3.7. Argument and result passing conventions"><i class="replaceable"><tt>ALLOCATION</tt></i></a> = <tt class="constant">:ALLOCA</tt>.]</p></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="dffi-examples"></a>30.3.9. Examples</h3></div></div><div></div></div><div class="toc"><dl><dt><span class="section"><a href="dffi.html#dffi-ex-more">30.3.9.1. More examples</a></span></dt></dl></div><div class="example"><a id="dffi-simple"></a><p class="title"><b>Example 30.5. Simple declarations and access</b></p><p>The <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> declaration

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
struct foo {
    int a;
    struct foo * b[100];
};
</pre></td></tr></table><p>

corresponds to

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(def-c-struct foo
  (a int)
  (b (c-array (c-ptr foo) 100)))
</pre></td></tr></table><p>The element access

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
struct foo f;
f.b[7].a
</pre></td></tr></table><p>

corresponds to

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(declare (type foo f))
(foo-a (aref (foo-b f) 7)) or (slot-value (aref (slot-value f 'b) 7) 'a)
</pre></td></tr></table></div><div class="example"><a id="dffi-extern-var"></a><p class="title"><b>Example 30.6. external <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> variable and some accesses</b></p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
struct bar {
    short x, y;
    char a, b;
    int z;
    struct bar * n;
};

extern struct bar * my_struct;

my_struct-&gt;x++;
my_struct-&gt;a = 5;
my_struct = my_struct-&gt;n;
</pre></td></tr></table><p>

corresponds to

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(def-c-struct bar
  (x short)
  (y short)
  (a char)
  (b char) ; or (b character) if it represents a character, not a number
  (z int)
  (n (c-ptr bar)))

(def-c-var my_struct (:type (c-ptr bar)))

(setq my_struct (let ((s my_struct)) (incf (slot-value s 'x)) s))
or (incf (slot my_struct 'x))
(setq my_struct (let ((s my_struct)) (setf (slot-value s 'a) 5) s))
or (setf (slot my_struct 'a) 5)
(setq my_struct (slot-value my_struct 'n))
or (setq my_struct (deref (slot my_struct 'n)))
</pre></td></tr></table></div><div class="example"><a id="dffi-extern-func1"></a><p class="title"><b>Example 30.7. Calling an external function</b></p><p>On ANSI <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> systems, <a href="http://www.opengroup.org/onlinepubs/007904975/basedefs/stdlib.h.html" target="_top"><tt class="filename">stdlib.h</tt></a> contains the declarations:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
typedef struct {
  int quot;   /* Quotient */
  int rem;    /* Remainder */
} div_t;
extern div_t div (int numer, int denom);
</pre></td></tr></table><p>

This translates to

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(def-c-struct (div_t :typedef)
  (quot int)
  (rem int))
(default-foreign-language :stdc)
(def-call-out div (:arguments (numer int) (denom int))
  (:return-type div_t))
</pre></td></tr></table><p>

Sample call from within Lisp:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(div 20 3)
<span class="returnvalue">#S(DIV_T :QUOT 6 :REM 2)</span>
</pre></td></tr></table></div><div class="example"><a id="dffi-extern-func2"></a><p class="title"><b>Example 30.8. Another example for calling an external function</b></p><p>Suppose the following is defined in a file
 <tt class="filename">cfun.c</tt>:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
struct cfunr { int x; char *s; };
struct cfunr * cfun (int i,char *s,struct cfunr * r,int a[10]) {
  int j;
  struct cfunr * r2;
  printf("i = %d\n", i);
  printf("s = %s\n", s);
  printf("r-&gt;x = %d\n", r-&gt;x);
  printf("r-&gt;s = %s\n", r-&gt;s);
  for (j = 0; j &lt; 10; j++) printf("a[%d] = %d.\n", j, a[j]);
  r2 = (struct cfunr *) malloc (sizeof (struct cfunr));
  r2-&gt;x = i+5;
  r2-&gt;s = "A C string";
  return r2;
}
</pre></td></tr></table><p>

It is possible to call this function from Lisp using the file
<tt class="filename">callcfun.lisp</tt> (do not call it
<tt class="filename">cfun.lisp</tt> - <a href="http://www.lisp.org/HyperSpec/Body/fun_compile-file.html" target="_top"><tt class="function">COMPILE-FILE</tt></a> would
<a href="system-dict.html#c-file-overwrite">overwrite</a>
<tt class="filename">cfun.c</tt>) whose contents is:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="http://www.lisp.org/HyperSpec/Body/mac_defpackage.html" target="_top"><tt class="function">DEFPACKAGE</tt></a> "TEST-C-CALL" (:use "LISP" "FFI"))
(<a href="http://www.lisp.org/HyperSpec/Body/mac_in-package.html" target="_top"><tt class="function">IN-PACKAGE</tt></a> "TEST-C-CALL")
(eval-when (compile) (setq <a href="dffi.html#ffi-extern-output"><tt class="varname">FFI:*OUTPUT-C-FUNCTIONS*</tt></a> t))
(def-c-struct cfunr (x int) (s c-string))
(default-foreign-language :stdc)
(def-call-out cfun
    (:arguments (i int)
                (s c-string)
                (r (c-ptr cfunr) :in :alloca)
                (a (c-ptr (c-array int 10)) :in :alloca))
  (:return-type (c-ptr cfunr)))
(defun call-cfun ()
  (cfun 5 "A Lisp string" (make-cfunr :x 10 :s "Another Lisp string")
        '#(0 1 2 3 4 5 6 7 8 9)))
</pre></td></tr></table><p>

Use the <a href="modules.html" title="30.2. Extensions-2.2. External Modules">module</a> facility:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
$ clisp-link create-module-set cfun callcfun.c
$ cc -O -c cfun.c
$ cd cfun
$ ln -s ../cfun.o cfun.o
Add cfun.o to NEW_LIBS and NEW_FILES in link.sh.
$ cd ..
$ base/lisp.run -M base/lispinit.mem -c callcfun.lisp
$ clisp-link add-module-set cfun base base+cfun
$ base+cfun/lisp.run -M base+cfun/lispinit.mem -i callcfun
&gt; (test-c-call::call-cfun)
i = 5
s = A Lisp string
r-&gt;x = 10
r-&gt;s = Another Lisp string
a[0] = 0.
a[1] = 1.
a[2] = 2.
a[3] = 3.
a[4] = 4.
a[5] = 5.
a[6] = 6.
a[7] = 7.
a[8] = 8.
a[9] = 9.
#S(TEST-C-CALL::CFUNR :X 10 :S "A C string")
&gt;
$ rm -r base+cfun
</pre></td></tr></table><p>Note that there is a memory leak here: The return value
<tt class="varname">r2</tt> of <tt class="function">cfun()</tt> is
<a href="http://www.opengroup.org/onlinepubs/007904975/functions/malloc.html" target="_top"><tt class="function">malloc</tt></a>ed but never <a href="http://www.opengroup.org/onlinepubs/007904975/functions/free.html" target="_top"><tt class="function">free</tt></a>d. Specifying
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(:return-type (c-ptr cfunr) :malloc-free)
</pre></td></tr></table><p>
is not an alternative because this would also
<tt class="function">free(r2-&gt;x)</tt> but <tt class="varname">r2-&gt;x</tt> is a
pointer to static data.</p></div><div class="example"><a id="ex-call-in"></a><p class="title"><b>Example 30.9. Calling Lisp from <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a></b></p><p>To sort an array of double-floats using the Lisp function <a href="http://www.lisp.org/HyperSpec/Body/fun_sortcm_stable-sort.html" target="_top"><tt class="function">SORT</tt></a>
 instead of the <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> library function <a href="http://www.opengroup.org/onlinepubs/007904975/functions/qsort.html" target="_top"><tt class="function">qsort</tt></a>, one can use the
 following interface code <tt class="filename">sort1.c</tt>.
 The main problem is to pass a variable-sized array.

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
extern void lispsort_begin (int);
void* lispsort_function;
void lispsort_double (int n, double * array) {
    double * sorted_array;
    int i;
    lispsort_begin(n); /* store #'sort2 in lispsort_function */
    sorted_array = ((double * (*) (double *)) lispsort_function) (array);
    for (i = 0; i &lt; n; i++) array[i] = sorted_array[i];
    free(sorted_array);
}
</pre></td></tr></table><p>

This is accompanied by <tt class="filename">sort2.lisp</tt>:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="http://www.lisp.org/HyperSpec/Body/mac_defpackage.html" target="_top"><tt class="function">DEFPACKAGE</tt></a> "FFI-TEST" (:use "LISP" "FFI"))
(<a href="http://www.lisp.org/HyperSpec/Body/mac_in-package.html" target="_top"><tt class="function">IN-PACKAGE</tt></a> "FFI-TEST")
(eval-when (compile) (setq <a href="dffi.html#ffi-extern-output"><tt class="varname">FFI:*OUTPUT-C-FUNCTIONS*</tt></a> t))
(def-call-in lispsort_begin (:arguments (n int))
  (:return-type nil)
  (:language :stdc))
(def-c-var lispsort_function (:type c-pointer))
(defun lispsort_begin (n)
  (setf (cast lispsort_function
              `(c-function
                 (:arguments (v (c-ptr (c-array double-float ,n))))
                 (:return-type (c-ptr (c-array double-float ,n))
                               :malloc-free)))
        #'sort2))
(defun sort2 (v)
  (declare (type vector v))
  (sort v #'&lt;))
</pre></td></tr></table><p>

To test this, use the following test file <tt class="filename">sorttest.lisp</tt>:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(eval-when (compile) (setq <a href="dffi.html#ffi-extern-output"><tt class="varname">FFI:*OUTPUT-C-FUNCTIONS*</tt></a> t))
(def-call-out sort10
  (:name "lispsort_double")
  (:language :stdc)
  (:arguments (n int)
              (array (c-ptr (c-array double-float 10)) :in-out)))
</pre></td></tr></table><p>

Now try

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
$ clisp-link create-module-set sort sort2.c sorttest.c
$ cc -O -c sort1.c
$ cd sort
$ ln -s ../sort1.o sort1.o
</pre></td></tr></table><p>

Add <tt class="filename">sort1.o</tt> to <tt class="envar">NEW_LIBS</tt>
and <tt class="envar">NEW_FILES</tt> in <tt class="filename">link.sh</tt>.
Create a file <tt class="filename">package.lisp</tt> containing the
form <tt class="sexp">(<a href="http://www.lisp.org/HyperSpec/Body/mac_defpackage.html" target="_top"><tt class="function">DEFPACKAGE</tt></a> "FFI-TEST" (:use "LISP"
"FFI"))</tt> and add <tt class="filename">package.lisp</tt>
to <tt class="envar">TO_PRELOAD</tt> in <tt class="filename">link.sh</tt>.
Proceed:

</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
$ cd ..
$ base/lisp.run -M base/lispinit.mem -c sort2.lisp sorttest.lisp
$ clisp-link add-module-set sort base base+sort
$ base+sort/lisp.run -M base+sort/lispinit.mem -i sort2 sorttest
&gt; (sort10 10 '#(0.501d0 0.528d0 0.615d0 0.550d0 0.711d0
                0.523d0 0.585d0 0.670d0 0.271d0 0.063d0))
#(0.063d0 0.271d0 0.501d0 0.523d0 0.528d0 0.55d0 0.585d0 0.615d0 0.67d0 0.711d0)
$ rm -r base+sort
</pre></td></tr></table></div><div class="example"><a id="ex-call-in-dll"></a><p class="title"><b>Example 30.10. Calling Lisp from <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> dynamically</b></p><p>Create a dynamic library <tt class="filename">lispdll</tt>
 (<tt class="filename">#P".dll"</tt> on <a href="http://www.willows.com/" target="_top"><strong>Win32</strong></a>,
  <tt class="filename">#P".so"</tt> on <a href="http://www.UNIX-systems.org/online.html" target="_top"><strong>UNIX</strong></a>)
  with the following function:</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
typedef int (*LispFunc)(int parameter);
int CallInFunc(LispFunc f) {
  return f(5)+11;
}
</pre></td></tr></table><p>
  and call it from Lisp:
  </p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(ffi:def-call-out callout
  (:name "CallInFunc")
  (:library "lispdll.dll")
  (:arguments (function-arg
               (ffi:c-function (:arguments (number ffi:int))
                               (:return-type ffi:int) (:language :stdc))))
  (:return-type ffi:int)
  (:language :stdc))
(defun f (x) (* x 2))
<span class="returnvalue">F</span>
(callout #'f)
<span class="returnvalue">21</span>
</pre></td></tr></table></div><div class="example"><a id="dffi-gethostname"></a><p class="title"><b>Example 30.11. Variable size arguments:
  calling <a href="http://www.opengroup.org/onlinepubs/007904975/functions/gethostname.html" target="_top"><tt class="function">gethostname</tt></a> from <a href="http://clisp.cons.org" target="_top"><span><b class="command">CLISP</b></span></a></b></p><div class="funcsynopsis"><a id="gethostname-synopsis"></a><p><code class="funcdef">int <b class="fsfunc">gethostname</b>(</code><var class="pdparam">name</var>, <var class="pdparam">namelen</var><code>)</code>;<br /><code>char*</code> <code>name</code>;<br /><code>size_t</code> <code>namelen</code>;</p></div><p>
 follows a typical pattern of <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> "out"-parameter convention - it
 expects a pointer to a buffer it is going to fill.
 So you must view this parameter as either <tt class="constant">:OUT</tt> or <tt class="constant">:IN-OUT</tt>.
 Additionaly, one must tell the function the size of the buffer.
 Here <i class="replaceable"><tt>namelen</tt></i> is just an <tt class="constant">:IN</tt> parameter.
 Sometimes this will be an <tt class="constant">:IN-OUT</tt> parameter, returning the
 number of bytes actually filled in.</p><p>So <i class="replaceable"><tt>name</tt></i> is actually a pointer to an array of up to
 <i class="replaceable"><tt>namelen</tt></i> characters, regardless of what the
 poor <span class="type">char*</span> <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> prototype says, to be used like a
 <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a> <span class="type">string</span> (<tt class="constant">NULL</tt>-termination).  <a href="http://www.UNIX-systems.org/online.html" target="_top"><strong>UNIX</strong></a> specifies
 that “<span class="quote">host names are limited to
  <tt class="constant">HOST_NAME_MAX</tt> bytes</span>”, which is, of course,
 system dependent, but it appears that 256 is sufficient.</p><p>In the present example, you can use allocation <tt class="constant">:ALLOCA</tt>, like
 you would do in <a href="http://www.eskimo.com/~scs/C-faq/top.html" target="_top"><span><b class="command">C</b></span></a>: stack-allocate a temporary.</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="dffi.html#def-c-call-out"><tt class="function">FFI:DEF-C-CALL-OUT</tt></a> gethostname
  (:arguments (name (<a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a> (<a href="dffi.html#c-array-max"><span class="type">FFI:C-ARRAY-MAX</span></a> ffi:char 256))
		    <tt class="constant">:OUT</tt> <tt class="constant">:ALLOCA</tt>)
	      (len ffi:int))
  (:return-type ffi:int))

(defun myhostname ()
  (multiple-value-bind (success name)
      ;; <tt class="constant">:OUT</tt> and <tt class="constant">:IN-OUT</tt> parameters are returned as <a href="http://www.lisp.org/HyperSpec/Body/glo_m.html#multiple_values" target="_top">multiple values</a>
      (gethostname 256)
    (if (zerop success) name
	(error ...)))) ;; <a href="http://www.opengroup.org/onlinepubs/007904975/functions/strerror.html" target="_top"><tt class="function">strerror</tt></a>(<a href="http://www.opengroup.org/onlinepubs/007904975/functions/errno.html" target="_top"><tt class="varname">errno</tt></a>)

(defvar hostname (myhostname))
</pre></td></tr></table></div><div class="example"><a id="dffi-dll-var"></a><p class="title"><b>Example 30.12. Accessing variables in shared libraries.</b></p><p>Suppose one wants to access and modify variables that reside in
 shared libraries:
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
struct bar {
  double x, y;
  double out;
};

struct bar my_struct = {10.0, 20.5, 0.0};

double test_dll(struct bar *ptr)
{
  return ptr-&gt;out = ptr-&gt;out + ptr-&gt;x + ptr-&gt;y;
}
</pre></td></tr></table><p>This is compiled to <tt class="filename">libtest.so</tt> (or
 <tt class="filename">libtest.dll</tt>, depending on your platform).</p><p>Use the following lisp code:
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="http://www.lisp.org/HyperSpec/Body/fun_use-package.html" target="_top"><tt class="function">USE-PACKAGE</tt></a> "FFI")

(<a href="dffi.html#def-c-struct"><tt class="function">FFI:DEF-C-STRUCT</tt></a> bar
  (x double-float)
  (y double-float)
  (out double-float))

(<a href="dffi.html#def-call-out"><tt class="function">FFI:DEF-CALL-OUT</tt></a> get-own-c-float
  (:library "libtest.so")
  (:language :stdc)
  (:name "test_dll")
  (:arguments (ptr c-pointer :in :alloca))
  (:return-type double-float))

(<a href="dffi.html#def-c-var"><tt class="function">FFI:DEF-C-VAR</tt></a> my-c-var (:name "my_struct")
  (:library "libtest.so") (:type (c-ptr bar)))
</pre></td></tr></table><p>Note that <tt class="function">get-own-c-float</tt> takes a
 <a href="dffi.html#c-pointer"><span class="type">FFI:C-POINTER</span></a>, not a <tt class="type">(<a href="dffi.html#c-ptr"><span class="type">FFI:C-PTR</span></a> bar)</tt> as the
 argument.</p><p>Now you can access call <tt class="function">get-own-c-float</tt> on
<tt class="varname">my-c-var</tt>:
</p><table border="0" bgcolor="#E0E0E0"><tr><td><pre class="programlisting">
(<a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a> my-c-var)
<span class="returnvalue">#&lt;FOREIGN-ADDRESS #x282935D8&gt;</span>
(get-own-c-float (<a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a> my-c-var))
<span class="returnvalue">30.5d0</span>
(get-own-c-float (<a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a> my-c-var))
<span class="returnvalue">61.0d0</span>
(get-own-c-float (<a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a> my-c-var))
<span class="returnvalue">91.5d0</span>
(get-own-c-float (<a href="dffi.html#c-var-addr"><tt class="function">FFI:C-VAR-ADDRESS</tt></a> my-c-var))
<span class="returnvalue">122.0d0</span>
</pre></td></tr></table></div><div class="section" lang="en" xml:lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="dffi-ex-more"></a>30.3.9.1. More examples</h4></div></div><div></div></div><p>You can find more information and examples of the <a href="http://clisp.cons.org" target="_top"><span><b class="command">CLISP</b></span></a>
 <a href="dffi.html" title="30.3. Extensions-2.3. The Foreign Function Call Facility"><strong class="package">“<span class="quote">FFI</span>”</strong></a> in the following <tt class="email">&lt;<a href="mailto:clisp-list@sf.net">clisp-list@sf.net</a>&gt;</tt> messages:
 </p><div class="itemizedlist"><ul type="disc"><li><a href="http://article.gmane.org/gmane.lisp.clisp.general/7278" target="_top">"variable size values"</a></li><li><a href="http://article.gmane.org/gmane.lisp.clisp.general/6626" target="_top">"variable length arrays"</a></li></ul></div><p>
</p></div></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="modules.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="platform.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="affi.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">30.2. Extensions-2.2. External Modules </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 30.4. Extensions-2.4. The Amiga Foreign Function Call Facility</td></tr></table></div><div class="custom-footer"><hr width="100%" /><table width="100%"><tr><td align="left"><a href="http://clisp.cons.org"><img src="clisp.png" width="48" height="48" alt="[CLISP home]" /></a></td><td align="center"><a href="http://www.gnu.org"><img src="http://www.gnu.org/graphics/gnubanner.jpg" width="468" height="60" alt="[Come and see what GNU creates for YOU]" /></a></td><td align="right"><a href="http://sourceforge.net"><img src="http://sourceforge.net/sflogo.php?group_id=1355&amp;amp;type=2" width="125" height="37" alt="[SourceForge]" /></a></td></tr></table></div></body></html>
